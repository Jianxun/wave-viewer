schema_version: 2
current_sprint:
  - id: T-060
    title: Add atomic replay snapshot protocol for reload consistency
    owner: Executor
    dod:
      - Extend host-webview protocol types and validators with `host/replaySnapshot` carrying `{ revision, workspace, viewerState, tuples, reason }`.
      - Implement webview handler for `host/replaySnapshot` that atomically replaces workspace and tuple cache, then renders once.
      - Keep stale revision rejection semantics aligned with existing state messages.
    verify:
      - npm test -- tests/unit/protocol/messages.test.ts
      - npm test -- tests/extension/smoke.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-060.md
      adr: agents/adr/ADR-0018-atomic-reload-replay-snapshots.md
      spec: doc/specs/wave-viewer-mvp.md
    files:
      - src/core/dataset/types.ts
      - src/extension/types.ts
      - src/webview/main.ts
      - tests/unit/protocol/messages.test.ts
      - tests/extension/smoke.test.ts
  - id: T-061
    title: Replace reload tuple upsert fanout with viewer-scoped replay snapshots
    owner: Executor
    depends_on:
      - T-060
    dod:
      - Refactor `Reload All Files` host flow to compute replay payloads per open viewer session and publish `host/replaySnapshot` (not incremental tuple upserts) for reload-triggered updates.
      - Use deterministic dataset matching for replay hydration so imported/frozen/relative-path trace identities still refresh after CSV reload.
      - Remove reload-only heuristics that rely on side effects from later UI actions (for example adding a new plot/trace).
    verify:
      - npm test -- tests/extension/smoke.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-061.md
      adr: agents/adr/ADR-0018-atomic-reload-replay-snapshots.md
      spec: doc/specs/host-webview-protocol.md
    files:
      - src/extension.ts
      - src/extension/commands.ts
      - src/extension/sidePanel.ts
      - src/extension/viewerSessions.ts
      - src/extension/types.ts
      - tests/extension/smoke.test.ts
  - id: T-062
    title: Add regression coverage for reload-driven waveform refresh without new intents
    owner: Executor
    depends_on:
      - T-061
    dod:
      - Add tests proving waveform tuples refresh on `Reload All Files` for existing plotted traces without requiring any follow-up add/drop action.
      - Add coverage for layouts with persisted traces (including normalized source-id hydration path) to ensure replay snapshot replacement prevents stale vectors.
      - Ensure no regression for incremental interaction flows that still use tuple upserts.
    verify:
      - npm test -- tests/extension/smoke.test.ts
      - npm test -- tests/unit/webview/plotly/adapter.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-062.md
      spec: doc/specs/testing-strategy.md
    files:
      - tests/extension/smoke.test.ts
      - tests/unit/protocol/messages.test.ts
      - tests/unit/webview/plotly/adapter.test.ts
  - id: T-063
    title: Remove temporary reload workaround branches and align docs to replay-snapshot-only reload path
    owner: Executor
    depends_on:
      - T-062
    dod:
      - Remove obsolete reload workaround code paths that attempted partial tuple-cache refresh via heuristic matching.
      - Update README and protocol-oriented docs to distinguish incremental tuple upsert interactions from atomic reload replay snapshots.
      - Re-run focused verification matrix and document expected reload behavior for manual QA.
    verify:
      - npm test -- tests/extension/smoke.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-063.md
      spec: doc/specs/host-webview-protocol.md
    files:
      - src/extension.ts
      - src/webview/main.ts
      - README.md
      - doc/specs/host-webview-protocol.md
      - doc/specs/wave-viewer-mvp.md
      - tests/extension/smoke.test.ts
backlog:
  - id: T-064
    title: Implement normalized HDF5 waveform loader with run selection defaults
    owner: Executor
    dod:
      - Add extension-host ingestion path for normalized HDF5 files conforming to `doc/specs/hdf5-normalized-waveform-format.md`.
      - Map one selected run (`run_id`) into existing in-memory `Dataset` contract without changing reducer semantics.
      - Default run selection to first `/catalog/runs` entry and expose deterministic dataset path identity (`<file>#<run_id>`).
      - Validate required HDF5 metadata/paths and return actionable user-facing errors for invalid files.
    verify:
      - npm test -- tests/unit/dataset/selectDefaultX.test.ts
      - npm test -- tests/extension/smoke.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-064.md
      adr: agents/adr/ADR-0019-normalized-hdf5-waveform-ingestion-contract.md
      spec: doc/specs/hdf5-normalized-waveform-format.md
    files:
      - src/extension.ts
      - src/extension/commands.ts
      - src/core/dataset/types.ts
      - src/core/dataset/selectDefaultX.ts
      - tests/extension/smoke.test.ts
      - tests/unit/dataset/selectDefaultX.test.ts
exploration_candidates:
  - Evaluate adding a one-shot CLI migrator from legacy v1 layout YAML to v2 outside MVP core scope.
  - Evaluate migrating Wave Viewer from command-opened panel to custom editor architecture (`viewType`) only after host-authoritative protocol migration is complete.
  - Evaluate grouped signal tree taxonomy (flat vs prefix-grouped) for large datasets.
  - Evaluate decimation strategy for large CSV files under side-panel-driven multi-trace workflows.
