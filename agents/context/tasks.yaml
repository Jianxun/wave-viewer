schema_version: 2
current_sprint:
  - id: T-065
    title: Implement lazy host-side complex accessor projection for HDF5 AC datasets
    owner: Executor
    dod:
      - Extend HDF5 loader ingestion to accept scalar real samples and complex pair samples `[re, im]` while preserving real-only runtime payloads.
      - Enforce practical independent-variable sanity policy: always plot real part and reject only when imaginary component exceeds tolerance.
      - Implement symbolic accessor model with deterministic accessor set/order (`re`, `im`, `mag`, `phase`, `db20`) and lazy projection only when emitting trace tuples.
      - Enforce finite projection outputs, including `db20` floor via `eps=1e-30`, with actionable loader/projection errors.
    verify:
      - npm test -- tests/unit/core/hdf5/loadNormalizedHdf5.test.ts
      - npm test -- tests/unit/protocol/messages.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-065.md
      adr: agents/adr/ADR-0021-host-side-complex-projection-and-structured-signal-refs.md
      spec: doc/specs/hdf5-normalized-waveform-format.md
    files:
      - src/core/hdf5/loadNormalizedHdf5.ts
      - src/core/dataset/types.ts
      - src/extension.ts
      - src/extension/types.ts
      - tests/unit/core/hdf5/loadNormalizedHdf5.test.ts
      - tests/unit/protocol/messages.test.ts
      - examples/simulations/tb.spice.ac.h5
  - id: T-066
    title: Add symbolic accessor UX in signal tree with AC-default quick-add behavior
    owner: Executor
    depends_on:
      - T-065
    dod:
      - Make complex base signals expandable into virtual accessor children (`re`, `im`, `mag`, `phase`, `db20`) without eager vector materialization.
      - Ensure quick-add on complex base signal maps deterministically to `<base>.db20`.
      - Preserve existing behavior for real-only datasets and canonical signal actions.
      - Add/update unit coverage for signal tree hierarchy and quick-add mapping behavior.
    verify:
      - npm test -- tests/unit/extension/signalTree.test.ts
      - npm test -- tests/extension/smoke.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-066.md
      adr: agents/adr/ADR-0021-host-side-complex-projection-and-structured-signal-refs.md
    files:
      - src/extension/signalTree.ts
      - src/extension/commands.ts
      - src/extension.ts
      - tests/unit/extension/signalTree.test.ts
      - tests/extension/smoke.test.ts
  - id: T-067
    title: Upgrade layout persistence to schema v3 with structured signal refs
    owner: Executor
    depends_on:
      - T-065
    dod:
      - Introduce layout schema `version: 3` with signal refs persisted as `{ base, accessor? }`.
      - Keep runtime trace identity stable while decoupling persistence from flat accessor-string parsing.
      - Reject non-v3 layout imports with actionable errors and update docs/tests accordingly.
      - Ensure deterministic export ordering and roundtrip stability with accessor-bearing traces.
    verify:
      - npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts tests/unit/spec/roundtrip.test.ts tests/unit/spec/importErrors.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-067.md
      adr: agents/adr/ADR-0021-host-side-complex-projection-and-structured-signal-refs.md
      spec: doc/specs/wave-viewer-mvp.md
    files:
      - src/core/spec/importSpec.ts
      - src/core/spec/exportSpec.ts
      - src/core/spec/plotSpecV1.ts
      - tests/unit/core/spec/importSpec.test.ts
      - tests/unit/core/spec/exportSpec.test.ts
      - tests/unit/spec/roundtrip.test.ts
      - tests/unit/spec/importErrors.test.ts
      - doc/specs/wave-viewer-mvp.md
      - doc/specs/host-webview-protocol.md
  - id: T-068
    title: Lock ADR decision for per-plot X-axis linear/log scale
    owner: Architect
    dod:
      - Create `ADR-0022` documenting per-plot X-axis scale semantics, range-unit policy, validation rules, and rangeslider behavior in log mode.
      - Update `agents/context/contract.md` active ADR list and invariants to reference the accepted X-axis scale decision.
      - Define explicit non-goals (no data-transform fallback, no silent filtering) and migration/compatibility notes.
    verify:
      - ./venv/bin/python scripts/lint_tasks_state.py
    links:
      scratchpad: agents/scratchpads/T-068.md
      adr: agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md
      spec: doc/specs/wave-viewer-mvp.md
    files:
      - agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md
      - agents/context/contract.md
      - agents/context/project_status.md
  - id: T-069
    title: Freeze protocol and MVP spec for X-axis scale before implementation
    owner: Architect
    depends_on:
      - T-068
    dod:
      - Update protocol spec with a new host-authoritative webview intent for plot X-axis updates (scale and x-range patch semantics).
      - Update MVP spec to include per-plot `x.scale`, raw-unit `x.range` persistence in both scales, and log-toggle validation/error rules.
      - Add acceptance scenario matrix in spec for linear->log success, linear->log rejection, replay determinism, and import/export roundtrip.
    verify:
      - ./venv/bin/python scripts/lint_tasks_state.py
    links:
      scratchpad: agents/scratchpads/T-069.md
      adr: agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md
      spec: doc/specs/host-webview-protocol.md
    files:
      - doc/specs/host-webview-protocol.md
      - doc/specs/wave-viewer-mvp.md
      - agents/context/project_status.md
backlog:
  - id: T-070
    title: Implement host protocol and reducer support for plot X-axis scale updates
    owner: Executor
    depends_on:
      - T-069
    dod:
      - Add protocol message parsing/validation for plot X-axis update intent and route it through host transactions.
      - Extend workspace reducer/state to persist `plot.xScale` with default linear behavior and guard invalid log toggles (no positive X samples).
      - Ensure implementation conforms to frozen ADR/spec decisions from T-068/T-069 without editing ADR/spec/contract files.
    verify:
      - npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-070.md
      adr: agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md
      spec: doc/specs/host-webview-protocol.md
    files:
      - src/core/dataset/types.ts
      - src/extension/commands.ts
      - src/extension/types.ts
      - src/webview/state/workspaceState.ts
      - src/webview/state/reducer.ts
      - tests/unit/protocol/messages.test.ts
      - tests/extension/smoke.test.ts
  - id: T-071
    title: Implement webview X-scale UI and log-aware Plotly range conversions
    owner: Executor
    depends_on:
      - T-070
    dod:
      - Add per-plot X-scale control in plot header (`linear`/`log`) and wire it to host intent flow.
      - Update Plotly adapter/render relayout plumbing to convert raw-unit x-ranges <-> Plotly log-axis units deterministically.
      - Preserve existing rangeslider, pan, and reset interactions in both scales per frozen spec.
      - Ensure implementation conforms to frozen ADR/spec decisions from T-068/T-069 without editing ADR/spec/contract files.
    verify:
      - npm test -- tests/unit/webview/plotly/adapter.test.ts tests/unit/webview/plotly/renderPlot.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-071.md
      adr: agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md
      spec: doc/specs/wave-viewer-mvp.md
    files:
      - src/webview/main.ts
      - src/webview/index.html
      - src/webview/styles.css
      - src/webview/plotly/adapter.ts
      - src/webview/plotly/renderPlot.ts
      - tests/unit/webview/plotly/adapter.test.ts
      - tests/unit/webview/plotly/renderPlot.test.ts
  - id: T-072
    title: Add end-to-end regression coverage for X-axis log workflows
    owner: Executor
    depends_on:
      - T-071
    dod:
      - Add regression tests for valid log toggle, invalid log toggle rejection, relayout persistence, and replay/import roundtrip behavior.
      - Confirm no regressions in existing lane/axis routing and snapshot replay flows.
      - Ensure implementation conforms to frozen ADR/spec decisions from T-068/T-069 without editing ADR/spec/contract files.
    verify:
      - npm test -- tests/extension/smoke.test.ts tests/unit/spec/roundtrip.test.ts tests/unit/spec/importErrors.test.ts
      - npm run lint
    links:
      scratchpad: agents/scratchpads/T-072.md
      adr: agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md
      spec: doc/specs/wave-viewer-mvp.md
    files:
      - tests/extension/smoke.test.ts
      - tests/unit/spec/roundtrip.test.ts
      - tests/unit/spec/importErrors.test.ts
      - tests/unit/webview/workspaceState.test.ts
exploration_candidates:
  - Evaluate adding a one-shot CLI migrator from legacy v1 layout YAML to v2 outside MVP core scope.
  - Evaluate migrating Wave Viewer from command-opened panel to custom editor architecture (`viewType`) only after host-authoritative protocol migration is complete.
  - Evaluate grouped signal tree taxonomy (flat vs prefix-grouped) for large datasets.
  - Evaluate decimation strategy for large CSV files under side-panel-driven multi-trace workflows.
  - Evaluate lazy projection cache eviction policy for large AC datasets with many accessor-bearing traces.
