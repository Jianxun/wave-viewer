# T-064 Scratchpad

## Task summary (DoD + verify)
- Add extension-host ingestion path for normalized HDF5 files conforming to `doc/specs/hdf5-normalized-waveform-format.md`.
- Map one selected run (`run_id`) into existing in-memory `Dataset` contract without changing reducer semantics.
- Default run selection to first `/catalog/runs` entry and expose deterministic dataset path identity (`<file>#<run_id>`).
- Validate required HDF5 metadata/paths and return actionable user-facing errors for invalid files.

Verify:
- `npm test -- tests/unit/dataset/selectDefaultX.test.ts`
- `npm test -- tests/extension/smoke.test.ts`
- `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `doc/specs/hdf5-normalized-waveform-format.md`
- `agents/adr/ADR-0019-normalized-hdf5-waveform-ingestion-contract.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add parser-focused failing tests for normalized HDF5 default run selection and validation errors.
2. Implement a normalized HDF5 host loader and wire it into `loadDataset` without changing `Dataset` consumers.
3. Expand open-viewer dataset type detection to include HDF5 files.
4. Run required verification and close out task metadata.

## Milestone notes
- Added committed HDF5 fixtures for valid normalized ingestion and malformed validation cases.
- Added parser unit tests covering first-run default behavior and actionable failure paths.
- Implemented host loader using `h5wasm` in a synchronous subprocess path to keep extension interfaces unchanged.

## Patch summary
- Added `src/core/hdf5/loadNormalizedHdf5.ts`:
  - validates normalized file-level attributes and required nodes,
  - reads first `/catalog/runs` entry `run_id`,
  - maps `/runs/<run_id>/vectors` + `/vector_names` into `Dataset.columns`,
  - returns deterministic path identity `<file>#<run_id>`,
  - surfaces actionable errors for malformed normalized HDF5 files.
- Updated `src/extension.ts`:
  - `loadDataset` now routes `.h5` paths through normalized HDF5 loader and keeps CSV path unchanged,
  - side-panel load file picker now accepts `csv` and `h5`.
- Updated `src/extension/commands.ts`:
  - added `isHdf5File` and `isSupportedDatasetFile`,
  - open-viewer active document detection now accepts HDF5 files.
- Added tests and fixtures:
  - `tests/unit/core/hdf5/loadNormalizedHdf5.test.ts`
  - `tests/fixtures/hdf5/normalized-valid.h5`
  - `tests/fixtures/hdf5/normalized-missing-catalog-runs.h5`
  - `tests/fixtures/hdf5/normalized-mismatched-vectors.h5`
  - updated `tests/extension/smoke.test.ts` for supported dataset-type detection.

## PR URL
- Pending PR creation.

## Verification
- `npm test -- tests/unit/core/hdf5/loadNormalizedHdf5.test.ts` (pass)
- `npm test -- tests/unit/dataset/selectDefaultX.test.ts` (pass)
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- In Progress (ready for PR open + `ready_for_review` transition).

## Blockers / Questions
- None.

## Next steps
- Open PR to `main`, record PR number in `tasks_state`, set task status to `ready_for_review`, and push handoff to reviewer.
