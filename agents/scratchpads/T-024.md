# T-024 — Stabilize shared x-axis anchoring independent of lane reorder

## Task summary (DoD + verify)
- Decouple shared x-axis anchoring from workspace axis identity/order so x-axis ticks do not move when lanes reorder.
- Introduce a render-layer axis mapping strategy that preserves workspace axis ids (`y1..yN`) while assigning non-overlapping Plotly lane domains deterministically.
- Ensure add/remove/reorder axis operations keep lane rendering stable and preserve existing drag/drop lane targeting semantics.
- Add regression coverage proving x-axis tick placement remains stable across axis reorder operations.

Verify:
- `npm run lint`
- `npm test -- tests/unit/webview/plotly/adapter.test.ts tests/unit/webview/workspaceState.test.ts tests/extension/smoke.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `doc/specs/domain-stacked-shared-x-implementation.md`
- `agents/adr/ADR-0002-domain-stacked-yaxes-shared-x.md`
- `src/webview/plotly/adapter.ts`
- `src/webview/plotly/renderPlot.ts`
- `src/webview/main.ts`
- `tests/unit/webview/plotly/adapter.test.ts`
- `tests/unit/webview/workspaceState.test.ts`
- `tests/extension/smoke.test.ts`

## Plan
- Add render-layer axis mapping in Plotly adapter that maps axis IDs to lane-based Plotly refs/layout keys.
- Ensure relayout parsing uses the same mapping and x-axis anchoring is fixed independent of workspace axis IDs.
- Add/adjust unit regression tests for reorder stability and drop-lane semantics.
- Run verify commands and close out task state/PR handoff.

## Milestone notes
- Intake complete; task moved to in-progress.
- Implemented lane-index render mapping in Plotly adapter so workspace axis identity no longer controls Plotly axis keys.
- Added adapter regressions for reorder-stable shared x-axis anchoring and relayout parsing through render mapping.
- Verification suite passed (`lint` + required targeted tests).

## Patch summary
- `src/webview/plotly/adapter.ts`
  - Added render-layer axis mapping (`buildRenderAxisMappings`) from workspace axis order to Plotly layout keys (`yaxis`, `yaxis2`, ...).
  - Switched trace rendering and axis layout assignment to use render-layer mappings instead of direct workspace-id-to-Plotly mapping.
  - Anchored shared x-axis with `anchor: "free"` and `position: 0` so tick placement is decoupled from any specific workspace axis id.
  - Updated relayout range parsing to resolve Plotly axis updates back to workspace axis ids through render-layer mappings.
- `tests/unit/webview/plotly/adapter.test.ts`
  - Updated mapping expectations to lane-index semantics.
  - Added regression coverage for stable x-axis anchoring across axis reorder and relayout mapping behavior for reordered lanes.

## PR URL
- Pending branch push / PR creation.

## Verification
- `npm run lint` ✅
- `npm test -- tests/unit/webview/plotly/adapter.test.ts tests/unit/webview/workspaceState.test.ts tests/extension/smoke.test.ts` ✅

## Status request
- Ready for Review (after PR is opened and task state is updated)

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR to `main`, set `T-024` to `ready_for_review`, and hand off for review.
