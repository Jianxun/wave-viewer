# T-046 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Add host commands to open a layout file, save the active viewer state to layout, and save-as to a new layout file.
  - Reuse existing spec import/export validators so command paths reject malformed YAML with actionable errors.
  - Ensure command behavior is deterministic with active viewer/session selection and reports clear UX messages.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/types.ts`
- `src/extension/viewerSessions.ts`
- `src/core/spec/importSpec.ts`
- `src/core/spec/exportSpec.ts`
- `tests/extension/smoke.test.ts`
- `package.json`

## Plan
1. Add failing smoke tests for explicit Open Layout / Save Layout / Save Layout As command behavior.
2. Implement host commands with deterministic active-viewer targeting and layout/session binding updates.
3. Wire new commands in extension activation and command contributions.
4. Run required verification and complete closeout.

## Milestone notes
- Added failing smoke tests covering command IDs, open/save/save-as happy paths, malformed YAML rejection, and missing-active-viewer UX errors.
- Implemented new host command creators:
  - `createOpenLayoutCommand`
  - `createSaveLayoutCommand`
  - `createSaveLayoutAsCommand`
- Added import helper (`readPlotSpecDatasetPathV1`) so Open Layout resolves dataset path via spec shape validation before full import validation.
- Wired commands into extension activation and `package.json` command/activation contributions.
- Verified lint and smoke suite pass with new tests.

## Patch summary
- Added explicit layout command implementations in `src/extension/commands.ts` with clear active-viewer/session guardrails and success/error messaging.
- Added command dependency contracts for layout commands in `src/extension/types.ts`.
- Added command registration/constants/exports in `src/extension.ts`.
- Added command contributions and activation events in `package.json`.
- Added `readPlotSpecDatasetPathV1` to reuse import validators for layout open flows in `src/core/spec/importSpec.ts`.
- Added smoke tests for explicit layout commands in `tests/extension/smoke.test.ts`.

## PR URL
- Pending PR creation in closeout step.

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request (Done / Blocked / In Progress)
- In Progress (ready for PR open and task-state closeout).

## Blockers / Questions
- None.

## Next steps
- Push branch and open PR.
- Set `T-046` to `ready_for_review` with PR number and lint task-state file.
