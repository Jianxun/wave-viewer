# T-071 Scratchpad

## Task summary (DoD + verify)
- Add per-plot X-scale control in plot header (`linear`/`log`) and wire it to host intent flow.
- Update Plotly adapter/render relayout plumbing to convert raw-unit x-ranges <-> Plotly log-axis units deterministically.
- Preserve existing rangeslider, pan, and reset interactions in both scales per frozen spec.
- Ensure implementation conforms to frozen ADR/spec decisions from T-068/T-069 without editing ADR/spec/contract files.

Verify:
- `npm test -- tests/unit/webview/plotly/adapter.test.ts tests/unit/webview/plotly/renderPlot.test.ts`
- `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`
- `agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md`
- `doc/specs/wave-viewer-mvp.md`
- `src/webview/main.ts`
- `src/webview/index.html`
- `src/webview/styles.css`
- `src/webview/plotly/adapter.ts`
- `src/webview/plotly/renderPlot.ts`
- `tests/unit/webview/plotly/adapter.test.ts`
- `tests/unit/webview/plotly/renderPlot.test.ts`

## Plan
- Add/adjust unit tests for X-scale UI wiring and log range conversion behavior.
- Implement webview header control and intent wiring for x-scale updates.
- Implement deterministic raw<->log range conversion in Plotly adapter/render relayout flow.
- Verify targeted tests and lint.

## Milestone notes
- Intake complete.
- Added failing tests for log-scale X range conversion in adapter and renderer relayout updates.
- Implemented plot-header X scale control and webview intent wiring to `webview/intent/updatePlotXAxis`.
- Implemented deterministic raw-unit <-> Plotly log-unit conversions for figure render and relayout parsing.
- Verification targets pass.

## Patch summary
- `src/webview/index.html`
  - Added per-plot X-scale selector (`linear`/`log`) in the plot header.
- `src/webview/styles.css`
  - Added styling for the new X-scale control.
- `src/webview/main.ts`
  - Wired X-scale selector change events to `webview/intent/updatePlotXAxis`.
  - Updated relayout handling to parse x-range updates with scale-aware conversion.
  - Passed active plot scale into viewport reset/normalization helpers.
- `src/webview/plotly/adapter.ts`
  - Added X-scale helpers (`getXAxisScale`, `toPlotlyXAxisRange`, `fromPlotlyXAxisRange`).
  - Updated figure build to set `xaxis.type` and convert persisted raw-unit x-ranges to Plotly units in log mode.
  - Made tuple-derived X bounds scale-aware (positive finite bounds in log mode).
  - Updated relayout parsing to convert Plotly log-unit x-range back to raw units.
- `src/webview/plotly/renderPlot.ts`
  - Updated `resetAxes` and `setXViewport` to convert raw-unit ranges to Plotly units based on active X scale.
- `tests/unit/webview/plotly/adapter.test.ts`
  - Added tests for log-scale render conversion and relayout reverse conversion.
- `tests/unit/webview/plotly/renderPlot.test.ts`
  - Added tests for log-scale conversion in reset and viewport relayout updates.

## PR URL
- Pending.

## Verification
- `npm test -- tests/unit/webview/plotly/adapter.test.ts tests/unit/webview/plotly/renderPlot.test.ts` ✅
- `npm run lint` ✅

## Status request (Done / Blocked / In Progress)
- Done

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR to `main`, and update `tasks_state` to `ready_for_review` with PR number.
