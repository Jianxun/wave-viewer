# T-067 Scratchpad

## Task summary (DoD + verify)
- Introduce layout schema `version: 3` with signal refs persisted as `{ base, accessor? }`.
- Keep runtime trace identity stable while decoupling persistence from flat accessor-string parsing.
- Reject non-v3 layout imports with actionable errors and update docs/tests accordingly.
- Ensure deterministic export ordering and roundtrip stability with accessor-bearing traces.

Verify:
- `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts tests/unit/spec/roundtrip.test.ts tests/unit/spec/importErrors.test.ts`
- `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/adr/ADR-0021-host-side-complex-projection-and-structured-signal-refs.md`
- `src/core/spec/importSpec.ts`
- `src/core/spec/exportSpec.ts`
- `src/core/spec/plotSpecV1.ts`
- `tests/unit/core/spec/importSpec.test.ts`
- `tests/unit/core/spec/exportSpec.test.ts`
- `tests/unit/spec/roundtrip.test.ts`
- `tests/unit/spec/importErrors.test.ts`
- `doc/specs/wave-viewer-mvp.md`

## Plan
1. Convert spec types and validator/exporter internals from schema v2 to v3 structured signal refs.
2. Preserve runtime signal identity (`<base>` / `<base>.<accessor>`) while storing structured layout refs.
3. Update import/export/roundtrip/error tests for v3-only behavior and structured refs.
4. Update MVP YAML-layout docs to v3 schema examples and constraints.
5. Run required verification commands and prepare PR closeout.

## Milestone notes
- Intake complete: executor workflow followed, `T-067` moved to `in_progress`, linted tasks state, feature branch created.
- Implemented v3 schema model and import/export translation layer for structured refs.
- Reworked spec test suite to cover v3-only import, actionable errors, structured accessor roundtrip, deterministic output.
- Updated MVP spec docs for v3 structured signal persistence format.

## Patch summary
- `src/core/spec/plotSpecV1.ts`
  - Added schema constant `PLOT_SPEC_V3_VERSION = 3`.
  - Added structured signal types `PlotSpecSignalNameV3` and `PlotSpecSignalRefV3`.
  - Migrated layout types from v2 to v3 (`PlotSpecV3`, `PlotSpecPlotV3`, etc.).
- `src/core/spec/importSpec.ts`
  - Enforced v3-only import with updated actionable version/mode errors.
  - Added structured signal validation (`base` required, `accessor` optional for y only).
  - Reconstructed runtime trace identity from structured refs (`<base>.<accessor>`).
  - Preserved x-signal runtime identity as base-only.
  - Updated missing-signal checks to validate runtime signal identities derived from structured refs.
- `src/core/spec/exportSpec.ts`
  - Export now emits `version: 3` specs.
  - Persisted y trace signals as `{ base, accessor? }` via complex signal parsing.
  - Persisted x signal as base-only structured signal ref.
- `tests/unit/core/spec/importSpec.test.ts`
  - Migrated fixtures/assertions to v3 schema shape.
  - Added accessor-bearing trace import/runtime identity coverage.
- `tests/unit/core/spec/exportSpec.test.ts`
  - Migrated assertions to v3 shape and structured signal refs.
  - Added accessor-bearing export shape assertions.
- `tests/unit/spec/roundtrip.test.ts`
  - Updated roundtrip assertions for v3 deterministic output.
  - Added accessor-bearing structured ref roundtrip coverage.
- `tests/unit/spec/importErrors.test.ts`
  - Replaced legacy v1 errors with v3-focused import error coverage.
- `doc/specs/wave-viewer-mvp.md`
  - Updated layout artifact section to schema v3 and structured signal examples.

## PR URL
- TBD

## Verification
- `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts tests/unit/spec/roundtrip.test.ts tests/unit/spec/importErrors.test.ts` ✅
- `npm run lint` ✅

## Status request (Done / Blocked / In Progress)
- In Progress

## Blockers / Questions
- None.

## Next steps
- Commit patches.
- Open PR to `main` and record PR URL.
- Set `T-067` to `ready_for_review` with PR number.
