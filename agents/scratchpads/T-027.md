# T-027 Scratchpad

## Task summary (DoD + verify)
- Define and implement typed protocol messages for viewer binding updates (host -> webview) and side-panel trace injection using explicit tuple payloads `(x, y)` (host -> webview).
- Use full inline numeric arrays in payloads for MVP; do not introduce chunk/handle streaming in this task.
- Ensure protocol additions preserve backward-compatible reducer-level semantics for plot/lane assignment.
- Add/adjust protocol contract tests and extension smoke tests for the new message types.
- Keep runtime validation strict at host/webview boundaries.

Verify:
- `npm run lint`
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`

## Plan
- Inspect current protocol message types/validators and existing side-panel trace flow in host/webview.
- Add new message schemas/types for viewer binding + tuple trace injection.
- Update host senders and webview handlers while preserving reducer semantics.
- Add/update unit and smoke tests for protocol contracts and end-to-end messaging.
- Run verify commands and record results.

## Milestone notes
- Intake complete; task moved to `in_progress`.
- Added failing protocol and smoke tests for `host/viewerBindingUpdated` and `host/sidePanelTraceInjected`.
- Implemented host/webview protocol updates with strict runtime validation and tuple payload schema checks.
- Updated side-panel quick-add flow to post tuple trace injection payloads while preserving reducer-equivalent add semantics.
- Verification commands completed successfully.

## Patch summary
- `src/core/dataset/types.ts`
  - Added typed host message contracts:
    - `host/viewerBindingUpdated`
    - `host/sidePanelTraceInjected`
  - Added strict validators for new payloads, including tuple-array finite-number checks and `x.length === y.length`.
- `src/extension.ts`
  - Extended host message union with new protocol message types.
  - Added helper builders for viewer-binding and tuple trace injection payloads.
  - `createOpenViewerCommand` now posts `host/viewerBindingUpdated` on webview ready.
  - Side-panel standalone bind path now posts `host/viewerBindingUpdated` when dataset binding occurs.
  - Side-panel quick-add now emits `host/sidePanelTraceInjected` with explicit `(x, y)` arrays and metadata.
- `src/webview/main.ts`
  - Added handlers for `host/viewerBindingUpdated` and `host/sidePanelTraceInjected`.
  - Tuple injection path preserves reducer-level semantics by routing to existing normalized drop flow.
- Tests:
  - `tests/unit/protocol/messages.test.ts`
  - `tests/extension/smoke.test.ts`
  - Added and updated assertions for new message contracts and binding/injection behavior.

## PR URL
- Pending.

## Verification
- `npm run lint` ✅
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts` ✅

## Status request (Done / Blocked / In Progress)
- In Progress

## Blockers / Questions
- None.

## Next steps
- Implement protocol additions and tests.
