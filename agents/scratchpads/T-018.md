# T-018 — Migrate host-webview message flows to normalized protocol contracts

## Task summary (DoD + verify)
- Migrate required message contracts (`host/datasetLoaded`, `host/workspaceLoaded`, `host/workspacePatched`, `webview/workspaceChanged`, `webview/dropSignal`) to envelope-based handling.
- Ensure message handlers use runtime validators before dispatch/mutation.
- Verify compatibility behavior for invalid payloads and unknown message types.
- Keep reducer outcomes deterministic for equivalent message intents.

Verify:
- `npm run lint`
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`

## Plan
- [x] Audit current protocol envelope/validator usage in host and webview message handlers.
- [x] Add/adjust validation gates for required `host/*` and `webview/*` message contracts.
- [x] Extend tests for invalid payloads and unknown message behavior while preserving reducer determinism.
- [x] Run verify commands and capture results.

## Milestone notes
- Intake complete. Task set to `in_progress`.
- Implemented normalized `webview/dropSignal` host handling with reducer-backed workspace mutation.
- Switched host patch-style updates to `host/workspacePatched` with explicit `reason`.
- Tightened runtime payload validation for workspace-shaped envelopes and required reasons.

## Patch summary
- `src/core/dataset/types.ts`
  - Added stricter runtime workspace-shape validation for `host/workspaceLoaded`, `host/workspacePatched`, and `webview/workspaceChanged`.
  - Required `reason` for `webview/workspaceChanged` and validated `webview/dropSignal` payload contract.
- `src/extension.ts`
  - Added `host/workspacePatched` to outbound protocol union.
  - Added `webview/dropSignal` to inbound protocol union and implemented `applyDropSignalAction(...)` reducer mapping.
  - Updated side-panel signal action push path to post `host/workspacePatched` with reason metadata.
- `src/webview/main.ts`
  - Included `reason` when posting `webview/workspaceChanged`.
  - Added `host/workspacePatched` handling and status text update.
- `tests/unit/protocol/messages.test.ts`
  - Added coverage for `host/workspacePatched`, `webview/dropSignal`, and invalid/compatibility payload handling.
- `tests/extension/smoke.test.ts`
  - Added flow coverage for validated `webview/dropSignal` -> host mutation + `host/workspacePatched`.
  - Added invalid payload rejection behavior and deterministic equivalence test between side-panel and drop intents.

## PR URL
- Pending.

## Verification
- `npm run lint` ✅
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts` ✅
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts tests/unit/protocol/messages.test.ts` ✅

## Status request (Done / Blocked / In Progress)
- In Progress.

## Blockers / Questions
- None currently.

## Next steps
- Commit implementation changes, open PR to `main`, then set `T-018` state to `ready_for_review` with PR number.
