# T-066 Scratchpad

## Task summary (DoD + verify)
- Make complex base signals expandable into virtual accessor children (`re`, `im`, `mag`, `phase`, `db20`) without eager vector materialization.
- Ensure quick-add on complex base signal maps deterministically to `<base>.db20`.
- Preserve existing behavior for real-only datasets and canonical signal actions.
- Add/update unit coverage for signal tree hierarchy and quick-add mapping behavior.

Verify:
- `npm test -- tests/unit/extension/signalTree.test.ts`
- `npm test -- tests/extension/smoke.test.ts`
- `npm run lint`

## Read (paths)
- `agents/context/contract.md`
- `agents/adr/ADR-0021-host-side-complex-projection-and-structured-signal-refs.md`
- `src/extension/signalTree.ts`
- `src/extension/commands.ts`
- `src/extension.ts`
- `tests/unit/extension/signalTree.test.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add failing coverage for complex accessor children and quick-add mapping.
2. Implement signal-tree metadata/children for complex base signals without eager vectors.
3. Implement quick-add base-signal mapping to `.db20` while preserving non-quick-add behavior.
4. Run task verify commands and finalize handoff.

## Milestone notes
- Intake complete: `T-066` was `ready`; dependency `T-065` is `done`.
- Added and passed focused tests for complex accessor tree children and quick-add mapping.
- Updated side-panel quick-add flow to map complex base signals to `.db20`.

## Patch summary
- `src/extension/signalTree.ts`
  - Added optional complex metadata to tree datasets (`complexSignalPaths`, `complexSignalAccessors`).
  - Marked complex base signal entries as expandable and generated symbolic accessor children (`re`, `im`, `mag`, `phase`, `db20`).
  - Kept accessor children symbolic by constructing names only (no vector materialization).
- `src/extension.ts`
  - Added `resolveQuickAddSignal()` to deterministically map complex base quick-add selections to `<base>.db20`.
  - Wired quick-add path (both viewer and no-viewer fallback) to use mapped quick-add signal and source id.
  - Passed complex signal metadata into signal tree refresh payload.
- `tests/unit/extension/signalTree.test.ts`
  - Added coverage asserting complex base signal expansion into virtual accessor children.
- `tests/extension/smoke.test.ts`
  - Added coverage for `resolveQuickAddSignal()` complex-base mapping behavior.
  - Updated one existing assertion for quick-add fallback source-id string to reflect mapped quick-add signal.
  - Updated one existing reference-only import error-message expectation to current wording.

## PR URL
- Pending creation.

## Verification
- `npm test -- tests/unit/extension/signalTree.test.ts` ✅ pass (8 tests).
- `npm test -- tests/extension/smoke.test.ts` ✅ pass (116 tests).
- `npm run lint` ✅ pass (`tsc --noEmit`).

## Status request
- In Progress (pending PR open + task state finalization).

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR to `main`, update `tasks_state` to `ready_for_review` with PR number.
