# T-011 Scratchpad

## Task summary (DoD + verify)
- DoD:
- Update spec schema/types to represent domain-stacked lane semantics.
- Keep deterministic ordering guarantees for plots, axes, and traces.
- Define explicit handling for legacy specs (clear error or controlled migration path, documented in code/tests).
- Update import/export validation for axis references and missing signals.
- Verify:
- `npm run lint`
- `npm test -- tests/unit/spec/roundtrip.test.ts tests/unit/spec/importErrors.test.ts`

## Read (paths)
- doc/specs/domain-stacked-shared-x-implementation.md
- doc/specs/wave-viewer-mvp.md
- agents/context/contract.md
- agents/context/tasks.yaml
- agents/context/tasks_state.yaml
- agents/adr/ADR-0002-domain-stacked-yaxes-shared-x.md
- src/core/spec/plotSpecV1.ts
- src/core/spec/exportSpec.ts
- src/core/spec/importSpec.ts
- tests/unit/spec/roundtrip.test.ts
- tests/unit/spec/importErrors.test.ts

## Plan
- 1) Convert spec axis schema away from overlay-era `side`, and enforce legacy handling path in importer.
- 2) Update importer/exporter behavior and validation to match lane semantics while preserving deterministic order.
- 3) Update/extend roundtrip + import error tests first (TDD), then implement code to satisfy tests.
- 4) Run verify commands and capture outputs.
- 5) Prepare closeout notes and PR metadata.

## Milestone notes
- Intake complete: `T-011` is `ready`; dependency `T-010` is `done`.
- Task understanding: spec v1 should now model lane semantics (`axes[]` order as lane order, no `side` usage). Legacy `side` should be handled explicitly; for this task I will reject legacy specs with a clear actionable import error.
- TDD: added failing test for legacy `axis.side` rejection in importer, then implemented importer/exporter/type updates to pass.

## Patch summary
- `src/core/spec/plotSpecV1.ts`
- Removed `side` from `PlotSpecAxisV1` schema to align with lane semantics.
- `src/core/spec/exportSpec.ts`
- Stopped exporting any axis `side` field to keep schema deterministic and lane-oriented.
- `src/core/spec/importSpec.ts`
- Added explicit legacy handling: any axis `side` now fails import with clear migration guidance.
- `tests/unit/spec/roundtrip.test.ts`
- Updated roundtrip fixtures to lane semantics and added assertion that YAML does not serialize `side`.
- Added lane-order replay case to ensure axis/traces ordering is preserved.
- `tests/unit/spec/importErrors.test.ts`
- Updated fixtures and added explicit legacy-side rejection test.

## PR URL
- Pending PR creation.

## Verification
- `./venv/bin/python scripts/lint_tasks_state.py`
- PASS (`OK: tasks.yaml and tasks_state.yaml are consistent.`)
- `npm test -- tests/unit/spec/roundtrip.test.ts tests/unit/spec/importErrors.test.ts`
- PASS (7 tests passed)
- `npm run lint`
- PASS (`tsc --noEmit`)

## Status request
- In Progress (pending PR open and task-state finalization)

## Blockers / Questions
- None.

## Next steps
- Open PR to `main`.
- Update `agents/context/tasks_state.yaml` to `ready_for_review` with PR number and run linter.
