# T-005 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Map `PlotState` to Plotly traces/layout including `y1..yN` axis mapping.
  - Render right-pane canvas from active tab state and update on state changes.
  - Capture/restore zoom and range updates in state for deterministic replay fields.
  - Support visibility toggles and axis reassignment reflected live in chart.
- Verify:
  - `npm run lint`
  - `npm test`

## Read (paths)
- `agents/roles/executor.md`
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `doc/specs/wave-viewer-mvp.md`
- `src/extension.ts`
- `src/webview/main.ts`
- `src/webview/state/workspaceState.ts`
- `src/webview/state/reducer.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add unit tests for Plotly adapter mapping (`y1..yN`, visibility, axis assignment, range restore).
2. Implement Plotly adapter + renderer and wire webview main loop to render active plot state.
3. Capture Plotly zoom/range relayout events and sync `xRange`/axis ranges back into workspace state.
4. Run verification, update task state/ scratchpad, push, and open PR.

## Milestone notes
- 2026-02-11: Intake complete; selected `T-005`, created branch and scratchpad.
- 2026-02-11: Added failing adapter tests first (`tests/unit/webview/plotly/adapter.test.ts`) for axis mapping, visibility, persisted ranges, and relayout parsing.
- 2026-02-11: Implemented Plotly adapter/renderer, wired main webview render loop, and enabled range capture via `plotly_relayout`.
- 2026-02-11: Updated extension payload to include numeric column values for plotting and refreshed smoke test expectations.

## Patch summary
- Added Plotly adapter and figure mapping in `src/webview/plotly/adapter.ts`:
  - `y1..yN` to Plotly axis mapping (`yaxis`, `yaxis2`, ...),
  - trace generation with visibility and axis reassignment support,
  - layout generation from axis state including persisted `xRange` and `axis.range`,
  - relayout payload parsing (`range` and `autorange`) for deterministic range capture.
- Added Plotly renderer in `src/webview/plotly/renderPlot.ts` using `Plotly.react` plus one-time relayout listener wiring.
- Added module declaration `src/webview/plotly/plotly-js-dist-min.d.ts` and installed `plotly.js-dist-min`.
- Updated webview state/actions:
  - `setPlotXRange` in `src/webview/state/workspaceState.ts`,
  - new reducer action `plot/setXRange` in `src/webview/state/reducer.ts`.
- Updated `src/webview/main.ts` to:
  - keep dataset numeric columns in memory,
  - render active plot to Plotly on every state change,
  - capture zoom/pan/autorange updates and persist them back to workspace state.
- Updated extension message payload in `src/extension.ts` to send numeric values to webview.
- Updated tests:
  - new adapter unit tests in `tests/unit/webview/plotly/adapter.test.ts`,
  - adjusted extension smoke expectations in `tests/extension/smoke.test.ts`.
- Updated `tsconfig.json` include list for `.d.ts` files.

## PR URL
- Pending PR open.

## Verification
- `npm run lint` passed.
- `npm test -- tests/unit/webview/plotly/adapter.test.ts` passed.
- `npm test` passed (`24` tests across `5` files).

## Status request
- Ready for Review (pending PR open and task-state PR link update).

## Blockers / Questions
- None currently.

## Next steps
- Push branch, open PR to `main`, then set `T-005` to `ready_for_review` with PR number.
