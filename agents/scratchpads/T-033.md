# T-033 Scratchpad

## Task summary (DoD + verify)
- Add typed/runtime-validated `webview/intent/*` messages and host `stateSnapshot/statePatch` messages with monotonic revision.
- Enforce stale host-state rejection in webview (`revision <= lastAppliedRevision` is ignored).
- Keep tuple transport separate from structural state updates.
- Add protocol contract tests for validation and revision ordering semantics.

Verify:
- `npm run lint`
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/adr/ADR-0010-revisioned-intent-based-protocol.md`
- `doc/specs/host-webview-protocol.md`

## Plan
- Inspect current protocol types/validators and message flows in host/webview.
- Add/adjust v2 typed message contracts and runtime validators for intents and revisioned host state messages.
- Enforce stale revision rejection on webview host-state apply path.
- Add/update protocol tests and smoke coverage for validation + revision ordering.
- Run verify commands and update task artifacts.

## Milestone notes
- Intake complete.
- Added v2 protocol envelope contracts and runtime validators for `webview/intent/*`, `host/stateSnapshot`, `host/statePatch`, and `host/tupleUpsert`.
- Migrated host/webview runtime messaging to v2 names with revisioned state payloads and tuple/state separation.
- Added stale host revision rejection logic in webview (`revision <= lastAppliedRevision` ignored).
- Updated protocol and smoke tests for v2 validation and revision-ordering semantics.

## Patch summary
- Updated protocol version and runtime validators to support v2 contracts while retaining temporary legacy parsing compatibility.
- Updated extension message types and drop-signal action typing to include `webview/intent/dropSignal`.
- Migrated command and side-panel host emit paths to:
  - `host/tupleUpsert` for tuple transport only
  - `host/stateSnapshot` and `host/statePatch` for structural state with monotonic `revision` and `viewerState`
- Updated webview message handling to:
  - emit `webview/intent/dropSignal` with `viewerId` and `requestId`
  - ignore stale host state messages where `revision <= lastAppliedRevision`
  - consume `host/tupleUpsert` separately from structural state updates
- Updated protocol unit tests and extension smoke tests to validate v2 payload shapes and revision-order semantics.

## PR URL
- Pending.

## Verification
- `npm run lint` (pass)
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts` (pass)

## Status request (Done / Blocked / In Progress)
- Done.

## Blockers / Questions
- None.

## Next steps
- Push branch and open PR to `main`.
- Set `T-033` to `ready_for_review` with PR number and re-run task-state linter.
