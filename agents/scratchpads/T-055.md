# T-055 Scratchpad

## Task Summary (DoD + Verify)
- Title: Redefine v2 layout schema to support multi-dataset workspaces
- DoD:
  - Replace single-dataset `version: 2` layout contract (`dataset.path`) with multi-dataset `datasets[]` + `active_dataset`.
  - Require dataset-qualified references for all persisted signal bindings (`x.dataset` + `x.signal`, and `signals[label] -> {dataset, signal}`).
  - Keep schema version at `2` and intentionally reject legacy single-dataset v2 payloads (no compatibility branch).
- Verify:
  - `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts`
  - `npm run lint`

## Read
- `agents/roles/executor.md`
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/adr/ADR-0015-v2-layout-multi-dataset-single-workspace.md`
- `doc/specs/wave-viewer-mvp.md`
- `src/core/spec/plotSpecV1.ts`
- `src/core/spec/importSpec.ts`
- `src/core/spec/exportSpec.ts`
- `tests/unit/core/spec/importSpec.test.ts`
- `tests/unit/core/spec/exportSpec.test.ts`

## Plan
1. Add tests for multi-dataset v2 import/export semantics and legacy v2 rejection.
2. Implement schema and serializer/parser changes in spec core files.
3. Run targeted verification, then lint, then close out with PR.

## Milestone Notes
- Intake complete; task set to `in_progress`; state lint passed.
- Branch: `feature/T-055-multi-dataset-v2-schema`.
- Added failing tests for multi-dataset v2 schema and legacy single-dataset rejection.
- Implemented strict import/export schema migration to dataset-qualified references.

## Patch Summary
- Updated `PlotSpecV2` shape to use `datasets[]` + `active_dataset` and dataset-qualified x/y signal refs.
- Reworked import validation to:
  - require non-empty `datasets[]`,
  - validate dataset ids and cross-references for `active_dataset`, `x.dataset`, and lane signal datasets,
  - reject legacy single-dataset v2 payloads without compatibility fallback.
- Reworked import mapping to:
  - resolve dataset paths by dataset id,
  - return `datasetPath` from resolved `active_dataset`,
  - persist imported trace dataset identity via `sourceId = <datasetPath>::<signal>`.
- Reworked export mapping to:
  - emit `datasets[]` registry + `active_dataset`,
  - emit dataset-qualified `x` and lane `signals` entries,
  - infer additional dataset registry entries from trace `sourceId` values.
- Updated unit tests to verify new schema shape and strict rejection behavior.

## PR URL
- Pending.

## Verification
- `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts` (pass)
- `npm run lint` (pass)

## Status Request
- Ready for Review (pending PR creation)

## Blockers / Questions
- None currently.

## Next Steps
- Push branch and open PR to `main`.
