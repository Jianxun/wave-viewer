# T-049 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Update plot spec contract to treat explicit layout file as primary artifact while preserving `<csv>.wave-viewer.yaml` compatibility fallback.
  - Reduce machine-specific coupling by avoiding required absolute dataset paths when layout and CSV are colocated.
  - Add/refresh tests and docs for reproducible multi-layout workflows on one dataset.
- Verify:
  - `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts`
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/roles/executor.md`
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `src/core/spec/plotSpecV1.ts`
- `src/core/spec/importSpec.ts`
- `src/core/spec/exportSpec.ts`
- `src/extension/commands.ts`
- `src/extension.ts`
- `tests/extension/smoke.test.ts`
- `tests/unit/spec/importErrors.test.ts`
- `tests/unit/spec/roundtrip.test.ts`
- `doc/specs/wave-viewer-mvp.md`

## Plan
1. Add failing tests for layout-relative dataset path import/export and command-path behavior.
2. Implement spec path serialization/resolution and wire command/controller call sites.
3. Update MVP docs and run required verification.
4. Push branch, open PR, and transition task status for review.

## Milestone notes
- Intake complete; task moved to `in_progress` and branch `feature/T-049-layout-schema-portability` created.
- Added failing tests:
  - `tests/unit/core/spec/importSpec.test.ts` for relative path resolution and missing-spec-path errors.
  - `tests/unit/core/spec/exportSpec.test.ts` for relative path export behavior.
  - `tests/extension/smoke.test.ts` coverage for opening layout with relative dataset reference and saving colocated layout with relative dataset path.
- Implemented spec and command updates:
  - `dataset.path` now resolves via layout-spec context (`specPath`) on import.
  - export now serializes portable layout-relative paths when `specPath` is provided.
  - open/import/save/save-as flows now pass spec path context.
  - external layout-edit reloads resolve relative dataset references against layout location.
- Updated MVP spec doc with explicit layout primacy + sidecar fallback + relative path guidance.

## Patch summary
- Added optional `specPath` on import/export spec inputs in `src/core/spec/plotSpecV1.ts`.
- Updated `src/core/spec/importSpec.ts` to:
  - resolve relative `dataset.path` against layout path,
  - throw explicit error if a relative dataset path is provided without `specPath`,
  - support dataset-path read helper with spec-path context.
- Updated `src/core/spec/exportSpec.ts` to emit layout-relative dataset paths when `specPath` is known.
- Wired `specPath` through host commands in `src/extension/commands.ts`:
  - export spec,
  - import spec,
  - open layout,
  - save layout,
  - save layout as.
- Updated `src/extension.ts` autosave/external-reload path handling to pass layout context into export/import.
- Added new unit tests:
  - `tests/unit/core/spec/importSpec.test.ts`
  - `tests/unit/core/spec/exportSpec.test.ts`
- Extended smoke tests in `tests/extension/smoke.test.ts` for relative-path layout workflows.
- Updated `doc/specs/wave-viewer-mvp.md` section 7.2 with explicit-layout and portability guidance.

## PR URL
- https://github.com/Jianxun/wave-viewer/pull/57

## Verification
- `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts` (pass)
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request (Done / Blocked / In Progress)
- Done

## Blockers / Questions
- None.

## Next steps
- Push branch and open PR.
- Update `tasks_state` to `ready_for_review` with PR number, then run `./venv/bin/python scripts/lint_tasks_state.py`.
