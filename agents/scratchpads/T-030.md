# T-030 — Add deterministic `reference-only` spec persistence mode

## Task summary (DoD + verify)
- Implement export/import path for `reference-only` specs that preserve plotting intent without embedding full sample arrays.
- Ensure rerun workflow can bind fresh source data and reconstruct plot assignments deterministically.
- Add validation and tests for missing/outdated references with clear actionable errors.

Verify:
- `npm run lint`
- `npm test -- tests/unit/spec/importErrors.test.ts tests/unit/spec/roundtrip.test.ts tests/extension/smoke.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`

## Plan
- Add tests first for reference-only mode metadata, deterministic roundtrip, and reference mismatch errors.
- Implement spec schema updates and import/export validation for explicit `reference-only` mode.
- Wire extension import/export flow to enforce dataset-reference compatibility for rerun reconstruction.
- Run task verification commands and record outcomes.

## Milestone notes
- Intake complete: task selected and moved to `in_progress`.
- Added failing tests for explicit `reference-only` mode serialization and mode validation errors.
- Added smoke tests for import-time dataset reference mismatch handling.
- Implemented explicit `mode: reference-only` export/import contract and actionable errors for missing/unsupported modes.
- Implemented import guard to reject reference-only specs when `dataset.path` does not match the active CSV.
- Ran required verification commands successfully.

## Patch summary
- `src/core/spec/plotSpecV1.ts`
  - Added explicit persistence mode model with `REFERENCE_ONLY_SPEC_MODE`.
  - Extended `PlotSpecV1` to require `mode`.
- `src/core/spec/exportSpec.ts`
  - Export now writes `mode: reference-only` deterministically.
- `src/core/spec/importSpec.ts`
  - Import now validates `mode` explicitly.
  - Added actionable errors for missing mode and unsupported `portable-archive` mode.
  - Normalized imported spec includes explicit reference-only mode.
- `src/extension.ts`
  - Import command now rejects mismatched dataset references for reference-only specs with a clear rerun guidance message.
- `tests/unit/spec/roundtrip.test.ts`
  - Added assertion that exported YAML includes `mode: reference-only`.
- `tests/unit/spec/importErrors.test.ts`
  - Added mode validation error coverage.
  - Updated existing fixtures to include explicit mode.
- `tests/extension/smoke.test.ts`
  - Added import workflow coverage for dataset reference mismatch and successful matching-reference import.

## PR URL
- Pending PR creation.

## Verification
- `npm run lint` ✅
- `npm test -- tests/unit/spec/importErrors.test.ts tests/unit/spec/roundtrip.test.ts tests/extension/smoke.test.ts` ✅

## Status request (Done / Blocked / In Progress)
- In Progress

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR, and move task to `ready_for_review`.
