# T-029 — Implement tuple-trace ingestion path from Explorer to viewer

## Task summary (DoD + verify)
- Implement host-side mapping from selected Explorer signal to explicit tuple trace payloads (`x[]`, `y[]`, metadata) for viewer delivery.
- Ensure viewer state stores and renders only trace tuples received from host; avoid deriving plot data from full dataset snapshots inside viewer.
- Keep lane assignment and reducer behavior deterministic when adding tuple traces.
- Add unit/smoke tests proving mixed-grid traces from different sources can coexist in one viewer session.

Verify:
- `npm run lint`
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`

## Plan
- Add/adjust tests for tuple ingestion and mixed-grid coexistence first.
- Implement host-side tuple mapping for explorer actions and strict webview tuple-only rendering path.
- Validate deterministic reducer/lane assignment behavior remains unchanged.
- Run required verification commands and record outcomes.

## Milestone notes
- Intake complete: task selected and moved to `in_progress`.
- Added failing tests for tuple-only render ingestion and source metadata propagation.
- Implemented host tuple injection for side-panel and dropSignal add flows with deterministic source IDs and trace binding.
- Switched webview plotting path to render from host-provided tuple payloads and added mixed-grid coexistence coverage.
- Ran required verification commands successfully.

## Patch summary
- `src/webview/state/workspaceState.ts`
  - Added optional `sourceId` on `TraceState`.
  - Extended `addTrace` to accept/persist optional `sourceId` while preserving existing axis assignment semantics.
- `src/webview/state/reducer.ts`
  - Extended `trace/add` action payload to carry optional `sourceId`.
- `src/core/dataset/types.ts`
  - Updated protocol runtime validation for workspace traces to accept optional `sourceId`.
- `src/extension.ts`
  - Added deterministic `sourceId` helper (`<datasetPath>::<signal>`) for host trace mapping.
  - Extended side-panel/dropSignal reducer paths to attach `sourceId` to newly created traces.
  - Added host tuple injection for newly-added traces in:
    - `runResolvedSidePanelSignalAction` (side-panel add flows)
    - `createOpenViewerCommand` dropSignal handler
  - Extended tuple payload builder to optionally bind tuple metadata to concrete workspace trace IDs.
- `src/webview/main.ts`
  - Added webview tuple store keyed by `sourceId`.
  - Updated `host/sidePanelTraceInjected` handling to ingest/store tuples and ensure trace instances are added deterministically with `sourceId`.
  - Removed side-panel tuple path dependency on dataset-column-derived plotting.
- `src/webview/plotly/adapter.ts`
  - Replaced dataset-column rendering input with tuple-store input (`traceTuplesBySourceId`).
  - Rendered each trace from host-provided tuple arrays (`x`,`y`) via `trace.sourceId`.
  - Updated X-axis title/bounds to use tuple metadata (`xName`, `x`), with fallback to plot state.
- `src/webview/plotly/renderPlot.ts`
  - Updated renderer contract to pass tuple-store map into adapter.
- Tests
  - `tests/extension/smoke.test.ts`
    - Added assertions that add flows emit `host/sidePanelTraceInjected` and persist `sourceId` in workspace traces.
    - Added mixed-grid tuple injection coexistence test for one viewer session.
  - `tests/unit/webview/workspaceState.test.ts`
    - Added coverage for optional `sourceId` persistence on `trace/add`.
  - `tests/unit/webview/plotly/adapter.test.ts`
    - Migrated adapter tests to tuple-store input.
    - Added mixed-grid plotting coexistence test for different source tuples in one figure.
  - `tests/e2e/waveViewerReplay.test.ts`
    - Updated e2e adapter invocation to build tuple-store input and align rangeslider assertion shape.

## PR URL
- Pending PR creation.

## Verification
- `npm run lint` ✅
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts` ✅
- `npm test -- tests/unit/webview/plotly/adapter.test.ts tests/e2e/waveViewerReplay.test.ts` ✅
- `npm test` ✅

## Status request (Done / Blocked / In Progress)
- In Progress

## Blockers / Questions
- None.

## Next steps
- Implement code and tests, then open PR.
