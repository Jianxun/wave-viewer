# T-058 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Update user and architecture docs to reflect multi-dataset `version: 2` schema and viewer auto-open behavior.
  - Add regression coverage for dataset-qualified signal replay and no-active-viewer command success paths.
  - Remove stale single-dataset v2 examples from docs/tests to avoid contract ambiguity.
- Verify:
  - `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts`
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `README.md`
- `doc/specs/wave-viewer-mvp.md`
- `doc/specs/side-panel-workflow.md`
- `src/extension/commands.ts`
- `src/extension/sidePanel.ts`
- `src/core/spec/importSpec.ts`
- `tests/extension/smoke.test.ts`
- `tests/unit/core/spec/importSpec.test.ts`

## Plan
1. Add failing regression tests for dataset-qualified replay and no-active-viewer auto-open command flow.
2. Patch layout open/import hydration to resolve and use all referenced datasets.
3. Refresh docs to remove stale command/schema language and align with v2 multi-dataset routing.
4. Run required verification commands and prepare review handoff.

## Milestone notes
- Intake complete; `T-058` moved to `in_progress`.
- Added failing replay test showing multi-dataset open layout did not emit dataset-qualified tuples.
- Implemented dataset reference read helper and per-dataset replay hydration path.
- Updated README/spec/contract wording for current command surface and routing semantics.

## Patch summary
- Added `readPlotSpecDatasetsV1` helper to read all resolved dataset references from v2 layouts.
- Updated `createOpenLayoutCommand` and sidecar import path to validate with dataset-qualified available-signals maps.
- Updated replay tuple hydration to resolve trace tuples per source dataset path.
- Added smoke regressions for:
  - dataset-qualified tuple replay on multi-dataset `Open Layout`,
  - no-active-viewer side-panel command auto-open guard.
- Updated user/architecture docs for:
  - side-panel `Add to Plot`/`Add to New Axis` command surface,
  - no-focused-viewer auto-open behavior,
  - v2 multi-dataset layout semantics.

## PR URL
- Pending

## Verification
- `npm test -- tests/extension/smoke.test.ts -t "replays dataset-qualified tuples when opening a multi-dataset layout|ensures no-active-viewer side-panel commands auto-open a viewer target before dispatch"` (pass)
- `npm test -- tests/unit/core/spec/importSpec.test.ts tests/extension/smoke.test.ts` (pass)
- `npm test -- tests/unit/core/spec/importSpec.test.ts tests/unit/core/spec/exportSpec.test.ts` (pass)
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- Ready for Review (pending PR creation)

## Blockers / Questions
- None.

## Next steps
1. Open PR and set task to `ready_for_review` with PR number.
