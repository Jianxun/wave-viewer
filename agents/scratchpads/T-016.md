# T-016 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Add plot-canvas drop overlay that maps pointer location to domain-stacked lanes.
  - Implement drop-to-lane behavior matching lane domain boundaries from the Plotly adapter.
  - Add double-click quick-add from side panel to active/default target lane.
  - Ensure overlay, row-target drop, and quick-add paths share one dispatch contract.
- Verify:
  - `npm run lint`
  - `npm test -- tests/unit/webview/plotly/adapter.test.ts tests/extension/smoke.test.ts`

## Read (paths)
- agents/context/contract.md
- agents/context/project_status.md
- agents/context/tasks.yaml
- agents/context/tasks_state.yaml
- agents/roles/executor.md
- doc/specs/side-panel-workflow.md
- src/extension.ts
- src/extension/signalTree.ts
- src/webview/plotly/adapter.ts
- src/webview/components/SignalList.ts
- src/webview/index.html
- src/webview/styles.css
- src/webview/main.ts
- src/webview/dropSignal.ts
- tests/unit/webview/plotly/adapter.test.ts
- tests/extension/smoke.test.ts

## Plan
- Add adapter helpers for lane-domain metadata and normalized Y lane resolution.
- Add canvas overlay rendering + hit-testing and route drop handling through normalized `webview/dropSignal`.
- Add signal quick-add on double-click and route it through the same normalized drop contract.
- Add regression coverage for lane mapping and canvas-overlay host patch routing, then run verify commands.

## Milestone notes
- Intake complete: confirmed `T-016` is `ready`, moved it to `in_progress`, and created branch `feature/T-016-canvas-drop-overlay`.
- Added shared adapter helpers (`getAxisLaneDomains`, `resolveAxisIdFromNormalizedY`) and tests for lane order/domain mapping + deterministic gap tie behavior.
- Added plot-canvas overlay lane rendering and drag/drop lane targeting in webview using adapter-domain math.
- Added signal-name double-click quick-add and routed quick-add/axis-row/canvas-overlay through one `postDropSignal` contract (`webview/dropSignal`).
- Added extension smoke regression for `source: "canvas-overlay"` routing and host patch reason.

## Patch summary
- `src/webview/plotly/adapter.ts`
  - Added exported lane-domain helpers used for overlay hit-testing and centralized lane math reuse.
- `tests/unit/webview/plotly/adapter.test.ts`
  - Added tests for domain generation and normalized Y to axis resolution.
- `src/webview/main.ts`
  - Added shared `postDropSignal` dispatch helper.
  - Added canvas drag/drop listeners, lane hit-testing, and overlay active-lane highlighting.
  - Updated axis-row drop and quick-add to use the same normalized drop message contract.
- `src/webview/components/SignalList.ts`
  - Added signal-name double-click quick-add callback.
- `src/webview/index.html`
  - Added dedicated `plot-root` + `plot-drop-overlay` layers inside plot canvas container.
- `src/webview/styles.css`
  - Added canvas overlay/lane styles and active lane affordance styles.
- `tests/extension/smoke.test.ts`
  - Added regression for `webview/dropSignal` with `source: "canvas-overlay"` and reason propagation.

## PR URL
- Pending PR creation/push.

## Verification
- `./venv/bin/python scripts/lint_tasks_state.py`
  - OK: tasks.yaml and tasks_state.yaml are consistent.
- `npm run lint`
  - pass
- `npm test -- tests/unit/webview/plotly/adapter.test.ts tests/extension/smoke.test.ts`
  - pass (25 tests)
- `npm test`
  - fail: existing e2e expectation mismatch in `tests/e2e/waveViewerReplay.test.ts` (`rangeslider` strict equality), outside `T-016` verify scope.

## Status request
- In Progress (ready to push/open PR, then set `ready_for_review` with PR number).

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR to `main`, update `T-016` task state to `ready_for_review`, and run tasks-state linter.
