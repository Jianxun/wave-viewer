# T-031 — Add deterministic `portable-archive` spec mode with embedded trace tuples

## Task summary (DoD + verify)
- Implement export/import path for `portable-archive` specs embedding full tuple trace data needed for offline replay.
- Keep archive serialization deterministic (trace order, axis assignment, numeric array ordering).
- Add regression tests validating archive replay works without accessing original source files.

Verify:
- `npm run lint`
- `npm test -- tests/unit/spec/roundtrip.test.ts tests/extension/smoke.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`

## Plan
- Add failing tests first for portable-archive export/import and offline replay behavior.
- Implement spec schema and import/export logic for deterministic portable archive payloads.
- Wire extension import flow so portable-archive replay does not require source CSV access.
- Run verification and prepare closeout updates.

## Milestone notes
- Intake complete: task selected and context loaded.
- Added failing tests first for portable-archive mode in unit roundtrip and extension import workflow.
- Implemented core spec mode support for portable archive export/import with deterministic tuple serialization order.
- Added extension portable tuple cache and replay hydration path to reuse archived tuples before dataset-derived fallback.
- Ran required verification commands successfully.

## Patch summary
- `src/core/spec/plotSpecV1.ts`
  - Added explicit `PORTABLE_ARCHIVE_SPEC_MODE` constant and expanded mode typing.
  - Extended spec/result types to carry archive tuple payloads and mode-aware import/export metadata.
- `src/core/spec/exportSpec.ts`
  - Added mode-aware export (`reference-only` default, `portable-archive` optional).
  - Portable archive export now serializes deterministic tuple payloads by first trace sourceId appearance order.
  - Added explicit export-time error when archive mode is missing tuple payloads.
- `src/core/spec/importSpec.ts`
  - Added mode validation for both supported modes.
  - Added portable archive schema validation (`archive.traces`, finite numeric arrays, duplicate source ids, tuple length checks).
  - Added mode-aware import behavior: reference-only validates available signals, portable-archive validates trace-to-tuple coverage.
  - Import now returns `mode` and `traceTupleBySourceId`.
- `src/extension.ts`
  - Import command now accepts portable-archive specs without reference-only dataset-path enforcement.
  - Added per-dataset portable tuple cache plumbing.
  - Replay hydration now injects archived tuples first (offline replay) with existing dataset tuple generation as fallback.
- `tests/unit/spec/roundtrip.test.ts`
  - Added deterministic portable-archive roundtrip coverage including embedded tuple map assertions.
- `tests/unit/spec/importErrors.test.ts`
  - Updated mode error expectations to reflect dual-mode support.
- `tests/extension/smoke.test.ts`
  - Added portable-archive import workflow regression test proving import succeeds with non-matching active CSV signals.

## PR URL
- Pending PR creation.

## Verification
- `npm run lint` ✅
- `npm test -- tests/unit/spec/roundtrip.test.ts tests/extension/smoke.test.ts` ✅

## Status request (Done / Blocked / In Progress)
- Done

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR, and move task to `ready_for_review`.
