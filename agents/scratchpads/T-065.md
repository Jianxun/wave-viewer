# T-065 Scratchpad

## Task summary (DoD + verify)
- Extend HDF5 loader ingestion to accept scalar real samples and complex pair samples `[re, im]` while preserving real-only runtime payloads.
- Enforce practical independent-variable sanity policy: always plot real part and reject only when imaginary component exceeds tolerance.
- Implement symbolic accessor model with deterministic accessor set/order (`re`, `im`, `mag`, `phase`, `db20`) and lazy projection only when emitting trace tuples.
- Enforce finite projection outputs, including `db20` floor via `eps=1e-30`, with actionable loader/projection errors.

Verify:
- `npm test -- tests/unit/core/hdf5/loadNormalizedHdf5.test.ts`
- `npm test -- tests/unit/protocol/messages.test.ts`
- `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/adr/ADR-0021-host-side-complex-projection-and-structured-signal-refs.md`
- `doc/specs/hdf5-normalized-waveform-format.md`
- `src/core/hdf5/loadNormalizedHdf5.ts`
- `src/core/dataset/types.ts`
- `src/extension.ts`
- `src/extension/types.ts`
- `src/extension/sidePanel.ts`
- `src/extension/commands.ts`
- `tests/unit/core/hdf5/loadNormalizedHdf5.test.ts`
- `tests/unit/protocol/messages.test.ts`
- `tests/extension/smoke.test.ts`

## Plan
- Add a typed complex accessor model and accessor parser with fixed ordering.
- Refactor normalized HDF5 ingestion to decode scalar-vs-complex samples per column and fail fast on invalid/mixed encodings.
- Reject complex-encoded independent-variable vectors with actionable errors.
- Keep dataset/runtime protocol payloads finite real arrays and add lazy signal projection for complex accessors only when tuples are emitted.
- Extend import/alias normalization paths so accessor-bearing signal strings normalize deterministically.
- Add unit tests for mixed scalar/complex ingestion, accessor projection math, and finite tuple protocol guarantees.

## Milestone notes
- Intake complete, task set `in_progress`, state linter passed.
- Implemented loader decode/projection model and extension integration.
- Added mixed scalar/complex fixture and focused protocol + smoke coverage.

## Patch summary
- Added `COMPLEX_SIGNAL_ACCESSORS` (`re`, `im`, `mag`, `phase`, `db20`) and `parseComplexSignalReference` in dataset core types.
- Reworked `loadNormalizedHdf5Dataset` to:
  - accept scalar real samples and complex pair samples,
  - reject mixed-encoding columns,
  - reject complex independent-variable columns,
  - keep runtime `dataset.columns` finite and real-only,
  - expose lazy `resolveSignalValues(signal)` projection for complex accessors,
  - apply finite-output checks for all projections (`db20` uses `eps=1e-30`).
- Extended extension loaded-dataset records with projection metadata/resolver plumbing.
- Updated side-panel tuple hydration/injection to resolve projected accessor signals lazily.
- Updated spec-import signal normalization to handle accessor-bearing aliases deterministically.
- Added tests:
  - loader coverage for mixed scalar/complex ingestion and projection math,
  - strict AC independent-variable rejection,
  - protocol rejection for non-finite tuple arrays,
  - side-panel alias+accessor selection normalization.

## PR URL
- Pending PR creation

## Verification
- `npm test -- tests/unit/core/hdf5/loadNormalizedHdf5.test.ts` ✅
- `npm test -- tests/unit/protocol/messages.test.ts` ✅
- `npm run lint` ✅
- `npm test -- tests/extension/smoke.test.ts -t "normalizes accessor-bearing alias selections for complex HDF5 signals"` ✅

## Status request (Done / Blocked / In Progress)
- In Progress (ready to open PR and request review)

## Blockers / Questions
- None

## Next steps
- Push branch and open PR to `main`.
- Update task state to `ready_for_review` with PR number and rerun state linter.
