# T-041 - Plot Lifecycle Host Authority

## Task summary (DoD + verify)
- DoD:
  - Add webview intents and host handlers so plot add/select/remove actions persist via host state transactions.
  - Replace local-only plot tab mutations in webview with host intent posting.
  - Verify plot tabs remain stable after focus changes and reopening viewer.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `src/webview/main.ts`
- `src/extension/commands.ts`
- `src/core/dataset/types.ts`
- `src/extension/types.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add failing tests for plot lifecycle intents and webview wiring.
2. Extend protocol/type validation for plot add/remove intents.
3. Add host command handlers for plot set-active/add/remove using host transactions.
4. Replace webview tab add/select/remove local dispatch with intent posts.
5. Run verify commands and close out task status.

## Milestone notes
- Intake complete; `T-041` moved to `in_progress` and task-state lint passed.
- Added tests first, observed expected failures for missing plot lifecycle intent handling.
- Implemented protocol + host + webview updates, then re-ran verifications to green.

## Patch summary
- Added protocol contracts for `webview/intent/addPlot` and `webview/intent/removePlot` and expanded webview message validation.
- Added host-side handlers in `createOpenViewerCommand` for:
  - `webview/intent/setActivePlot`
  - `webview/intent/addPlot`
  - `webview/intent/removePlot`
  - All handlers commit host transactions and emit `host/statePatch`.
- Updated webview tab lifecycle flow:
  - Added `postSetActivePlot`, `postAddPlot`, `postRemovePlot`.
  - Replaced local tab add/select/remove reducer dispatches with host intents.
- Added smoke tests for host transaction handling and webview wiring for plot lifecycle intents.

## PR URL
- Pending (to be filled during closeout).

## Verification
- `npm test -- tests/extension/smoke.test.ts` passed.
- `npm run lint` passed.

## Status request
- In Progress (awaiting push/PR and final task state transition).

## Blockers / Questions
- None.

## Next steps
- Commit changes and open PR to `main`.
- Set `T-041` to `ready_for_review` with PR number and re-run task-state lint.
