# T-034 Scratchpad

## Task summary (DoD + verify)
- Remove webview-to-host full workspace publication path (`webview/workspaceChanged`).
- Ensure webview local updates are driven by host-authoritative snapshot/patch messages only.
- Preserve drag/drop and interaction UX by emitting intents rather than direct state snapshots.
- Add regression coverage proving no dual-write overwrite path remains.

Verify:
- `npm run lint`
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/adr/ADR-0009-host-authoritative-workspace-and-viewer-state.md`
- `doc/specs/side-panel-workflow.md`

## Plan
- Inspect remaining webview-to-host full-state publish paths and host handlers for deprecated workspace publication.
- Remove deprecated publish path and keep intent-only webview emissions.
- Ensure host-driven snapshot/patch application remains the only state update source in webview.
- Add regression tests proving no dual-write overwrite path remains.
- Run verify commands and update task artifacts.

## Milestone notes
- Intake complete.
- Added regression tests that codify `webview/workspaceChanged` as a removed/invalid message path.
- Removed `webview/workspaceChanged` from runtime protocol typing/validation and extension host message unions.
- Removed explicit host handler branch for `webview/workspaceChanged`; invalid legacy envelopes now follow the generic invalid-message path.
- Verified intent-based drop flows and host snapshot/patch projection behavior remain intact.

## Patch summary
- Updated `src/core/dataset/types.ts`:
  - Removed `webview/workspaceChanged` from `WebviewToHostMessageType`.
  - Removed parsed union branch + runtime payload validator for `webview/workspaceChanged`.
- Updated `src/extension/types.ts`:
  - Removed `WebviewToHostMessage` union entry for `webview/workspaceChanged`.
- Updated `src/extension/commands.ts`:
  - Removed legacy `message.type === "webview/workspaceChanged"` handling block.
- Updated regression tests:
  - `tests/unit/protocol/messages.test.ts` now asserts `parseWebviewToHostMessage` rejects `webview/workspaceChanged`.
  - `tests/extension/smoke.test.ts` now asserts workspace mutation does not occur and message is treated as invalid/unknown input.

## PR URL
- Pending.

## Verification
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts` (pass)

## Status request (Done / Blocked / In Progress)
- Done.

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR, then set `T-034` to `ready_for_review` with PR number.
