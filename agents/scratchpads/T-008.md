# T-008 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Align `WorkspaceState`/`PlotState`/`AxisState` types with ADR-0002 and remove overlay-specific assumptions.
  - Ensure axis order in `plot.axes` is treated as top-to-bottom lane order.
  - Update reducer actions and invariants for axis add/remove/reorder under the lane model.
  - Preserve trace-instance semantics so a signal can appear in multiple lanes.
- Verify:
  - `npm run lint`
  - `npm test -- tests/unit/webview/workspaceState.test.ts`

## Read (paths)
- doc/specs/domain-stacked-shared-x-implementation.md
- doc/specs/wave-viewer-mvp.md
- agents/context/contract.md
- agents/context/tasks.yaml
- agents/context/tasks_state.yaml
- agents/context/project_status.md
- src/webview/state/workspaceState.ts
- src/webview/state/reducer.ts
- tests/unit/webview/workspaceState.test.ts

## Plan
- Add/adjust workspace state tests first for lane-order semantics and axis reordering.
- Implement state/reducer updates for non-overlay defaults and reorder action.
- Validate with required verify commands and close out task state.

## Milestone notes
- Intake complete; `T-008` moved to `in_progress`, `lint_tasks_state.py` passed.
- Added failing tests for lane-order and reorder invariants, then implemented `reorderAxis`.
- Made `AxisState.side` non-required and removed side defaults from workspace creation/axis add.
- Added narrow compatibility fixes required for `tsc` (`exportSpec` default side, e2e action payload cleanup).
- Reviewer follow-up: removed export-side default and updated spec import/export to preserve side-less axes for deterministic replay.

## Patch summary
- `src/webview/state/workspaceState.ts`
  - `AxisState.side` changed to optional.
  - `addAxis` no longer accepts/sets side.
  - Added `reorderAxis` with bounds checking and deterministic reordering.
  - Default plot axis now initializes as `{ id: "y1" }`.
- `src/webview/state/reducer.ts`
  - Added `axis/reorder` action and reducer case.
  - Removed side from `axis/add` and `axis/update` action typing.
- `tests/unit/webview/workspaceState.test.ts`
  - Removed side-specific assertions.
  - Added tests for lane order, reorder behavior, and reorder validation errors.
  - Updated reducer action-sequence test to include reorder.
- `src/core/spec/exportSpec.ts`
  - Removed export fallback side default; `side` is emitted only when defined in workspace state.
- `src/core/spec/importSpec.ts`
  - Treat `axis.side` as optional while still validating `"left" | "right"` when present.
- `src/core/spec/plotSpecV1.ts`
  - Made `PlotSpecAxisV1.side` optional to match lane-model workspace state.
- `tests/e2e/waveViewerReplay.test.ts`
  - Removed obsolete `side` payload for `axis/add`.
- `tests/unit/spec/roundtrip.test.ts`
  - Added regression test to assert side-less axis replay remains shape-preserving.

## PR URL
- https://github.com/Jianxun/wave-viewer/pull/9

## Verification
- `npm run lint` ✅
- `npm test -- tests/unit/webview/workspaceState.test.ts` ✅
- `npm test -- tests/unit/spec/roundtrip.test.ts tests/e2e/waveViewerReplay.test.ts` ✅
- `./venv/bin/python scripts/lint_tasks_state.py` ✅ (after `in_progress` transition)

## Status request
- Ready for Review

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR, set `T-008` to `ready_for_review` with PR number, re-run `lint_tasks_state.py`.
