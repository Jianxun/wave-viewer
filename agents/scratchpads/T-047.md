# T-047 Scratchpad

## Task summary (DoD + verify)
- Persist host-authoritative workspace revisions to a bound layout file using debounced writes.
- Use atomic write semantics (`temp` + `rename`) and record self-write metadata for watcher-loop suppression.
- Keep YAML schema output deterministic.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/types.ts`
- `src/core/spec/exportSpec.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add smoke tests for debounced autosave behavior and atomic write semantics.
2. Implement host autosave controller and atomic layout writer.
3. Wire autosave to host transaction commits and reuse atomic writer for manual layout saves.
4. Run verification and close out task state.

## Milestone notes
- Added `T-047` smoke coverage for:
  - debounce scheduling and last-revision persistence,
  - atomic layout write behavior with temp-file cleanup expectations.
- Implemented autosave controller and atomic writer in extension host layer.
- Routed host transaction commits through autosave scheduling.

## Patch summary
- Added `createLayoutAutosaveController`, `writeLayoutFileAtomically`, and deterministic YAML helper in `src/extension.ts`.
- Added autosave-related host types in `src/extension/types.ts`.
- Ensured deterministic YAML trailing newline in `src/core/spec/exportSpec.ts`.
- Added smoke tests for autosave debounce + atomic writes in `tests/extension/smoke.test.ts`.

## PR URL
- Pending PR creation.

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- In Progress

## Blockers / Questions
- None.

## Next steps
- Push feature branch.
- Open PR to `main`.
- Update task state to `ready_for_review` with PR number.
