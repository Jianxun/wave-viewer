# T-056 Scratchpad

## Task summary (DoD + verify)
- Title: Refactor host state/session model for single explorer and multi-viewer routing.
- DoD:
  - Update host session routing so one explorer can target multiple live viewers deterministically.
  - Introduce/refactor target-viewer resolution logic supporting: explicit target, focused eligible viewer, dataset-bound fallback, then open-new.
  - Ensure trace identity remains dataset-qualified end-to-end for mixed-dataset workspaces.
- Verify:
  - `npm test -- tests/unit/extension/signalTree.test.ts`
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/adr/ADR-0016-single-explorer-multi-viewer-routing-and-auto-open.md`
- `doc/specs/side-panel-workflow.md`
- `src/extension.ts`
- `src/extension/viewerSessions.ts`
- `src/extension/sidePanel.ts`
- `src/extension/types.ts`
- `tests/extension/smoke.test.ts`
- `tests/unit/extension/signalTree.test.ts`

## Plan
1. Add explicit-target-aware resolver API in viewer session registry and keep deterministic fallback ordering.
2. Wire host quick-add fallback to always stamp dataset-qualified `sourceId`.
3. Add/refresh regression coverage for routing precedence and dataset-qualified quick-add behavior.
4. Run task verify commands and prepare closeout.

## Milestone notes
- Intake complete: task `T-056` moved to `in_progress` and task-state lint passed.
- Resolver refactor implemented with optional explicit target support.
- Quick-add no-viewer fallback now persists dataset-qualified trace source identity.
- Smoke fixtures updated to current multi-dataset v2 layout schema so verify baseline passes.

## Patch summary
- Updated viewer session routing API and implementation to support optional explicit viewer targeting while preserving deterministic focused/dataset fallback behavior.
- Updated side-panel quick-add host fallback path to persist `sourceId` as `datasetPath::signal`.
- Added/updated smoke coverage for:
  - explicit target precedence,
  - explicit standalone bind routing,
  - quick-add dataset-qualified source identity,
  - multi-dataset v2 layout fixtures used by open/import/external-edit smoke flows.

## PR URL
- Pending PR creation from branch `feature/T-056-multi-viewer-routing`.

## Verification
- `npm test -- tests/extension/smoke.test.ts` passed.
- `npm test -- tests/unit/extension/signalTree.test.ts` passed.
- `npm run lint` passed.

## Status request
- In Progress (ready for PR open and task-state closeout).

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR to `main`, then update `agents/context/tasks_state.yaml` to `ready_for_review` with PR number and lint task state.
