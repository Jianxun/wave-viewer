# T-060 Scratchpad

## Task summary (DoD + verify)
- Extend host-webview protocol types and validators with `host/replaySnapshot` carrying `{ revision, workspace, viewerState, tuples, reason }`.
- Implement webview handler for `host/replaySnapshot` that atomically replaces workspace and tuple cache, then renders once.
- Keep stale revision rejection semantics aligned with existing state messages.
- Verify:
  - `npm test -- tests/unit/protocol/messages.test.ts`
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `src/core/dataset/types.ts`
- `src/extension/types.ts`
- `src/webview/main.ts`
- `tests/unit/protocol/messages.test.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add `host/replaySnapshot` protocol/type support and host payload validation.
2. Add protocol tests for replay snapshot accept/reject behavior.
3. Add webview handler that applies replay snapshot atomically with stale revision guard.
4. Update smoke assertions for replay snapshot semantics and rerun task verify commands.

## Milestone notes
- Set `T-060` to `in_progress` and passed `./venv/bin/python scripts/lint_tasks_state.py`.
- Created branch `feature/T-060-atomic-replay-snapshot`.
- Wrote failing tests first for replay snapshot parsing + webview stale replay checks, then implemented support.

## Patch summary
- Added `host/replaySnapshot` to protocol message unions and payload parser validation.
- Added protocol unit coverage for replay snapshot acceptance/rejection.
- Refactored webview authoritative state apply flow into a shared revision-guard helper.
- Added atomic replay snapshot handling that replaces workspace + tuple cache before one render call.
- Updated smoke coverage to assert replay snapshot stale-revision logs and message branch presence.

## PR URL
- Pending PR creation.

## Verification
- `./venv/bin/python scripts/lint_tasks_state.py` -> pass
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts` -> pass
- `npm test -- tests/unit/protocol/messages.test.ts` -> pass
- `npm test -- tests/extension/smoke.test.ts` -> pass
- `npm run lint` -> pass

## Status request
- In Progress

## Blockers / Questions
- None.

## Next steps
1. Push branch and open PR against `main`.
2. Update task state to `ready_for_review` with PR number and rerun linter.
