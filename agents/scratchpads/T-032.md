# T-032 Scratchpad

## Task summary (DoD + verify)
- Add a host-side state store that is the single writer for `WorkspaceState` and viewer interaction state (`activePlotId`, `activeAxisByPlotId`, `revision`).
- Route explorer/side-panel command mutations through host transactions only (no webview-authoritative writes).
- Keep reducer behavior deterministic while centralizing commit/apply logic in host.
- Add focused tests for transaction atomicity and revision monotonic increment behavior.

Verify:
- `npm run lint`
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/adr/ADR-0009-host-authoritative-workspace-and-viewer-state.md`
- `doc/specs/host-webview-protocol.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/sidePanel.ts`
- `src/extension/types.ts`
- `tests/extension/smoke.test.ts`

## Plan
- Inspect current host/webview state ownership and mutation flow.
- Add host-authoritative store abstraction with revisioned transactions.
- Route side-panel/explorer writes through host store transactions.
- Add/update tests for transaction atomicity and monotonic revision increments.
- Run verify commands and update task artifacts.

## Milestone notes
- Intake complete.
- Added TDD coverage for host-authoritative write rejection, transaction atomicity, and revision monotonicity.
- Added `createHostStateStore` and wired host mutation paths through store transactions.
- Updated side-panel mutation flow to commit host transactions and emit patch reason from committed transaction.

## Patch summary
- Added host-authoritative store (`src/extension/hostStateStore.ts`) that tracks `workspace`, `viewerState.activePlotId`, `viewerState.activeAxisByPlotId`, and monotonic `revision`.
- Routed `webview/dropSignal` mutations through `commitHostStateTransaction` when available.
- Rejected `webview/workspaceChanged` as non-authoritative with debug logging.
- Routed side-panel signal actions through host transaction commits.
- Added smoke coverage for:
  - host ignoring `webview/workspaceChanged`
  - atomic `add-to-new-axis` transaction behavior
  - monotonic revision increments across sequential transactions

## PR URL
- Pending.

## Verification
- `npm run lint` (pass)
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm test -- tests/unit/webview/workspaceState.test.ts` (pass)
- `npm test -- tests/extension/smoke.test.ts tests/unit/webview/workspaceState.test.ts` (pass)

## Status request (Done / Blocked / In Progress)
- In Progress.

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR, then set `T-032` to `ready_for_review` with PR number.
