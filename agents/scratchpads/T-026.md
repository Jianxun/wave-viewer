# T-026 Scratchpad

## Task summary (DoD + verify)
- Add explicit `viewerId` identity for each open Wave Viewer panel and maintain host-side registry (`viewerId -> panel`, `viewerId -> dataset?`).
- Track active/focused viewer session to route side-panel commands deterministically.
- Remove reliance on single-key `datasetPath -> panel` assumptions for side-panel command routing.
- Add regression tests for multiple-viewer routing and panel disposal cleanup.

Verify:
- `npm run lint`
- `npm test -- tests/extension/smoke.test.ts`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `doc/specs/side-panel-workflow.md`
- `agents/roles/executor.md`

## Plan
1. Add failing smoke tests for multi-viewer routing + disposal cleanup.
2. Implement viewer-session registry (`viewerId`, active viewer tracking, route helper) in extension host.
3. Verify with lint + smoke tests, then full closeout updates.

## Milestone notes
- 2026-02-12: Intake complete; selected `T-026` from `ready` queue.
- 2026-02-12: Added failing smoke tests for viewer-session routing (multi-viewer focus target + disposal cleanup).
- 2026-02-12: Implemented host-side viewer session registry and switched side-panel routing to focus-aware session resolution.
- 2026-02-12: Updated quick-add and remove-file panel checks to use session registry routing/indexes.

## Patch summary
- Added `createViewerSessionRegistry()` in `src/extension.ts` with:
  - explicit `viewerId` allocation for each open panel
  - `viewerId -> panel` and `viewerId -> datasetPath?` tracking
  - focused/active viewer tracking via panel view-state events
  - deterministic target selection for side-panel actions
  - disposal-safe cleanup for active/session and dataset indexes
- Replaced activate-time single-key panel routing with session-registry lookups.
- Extended extension smoke coverage with `T-026` tests for:
  - multi-viewer deterministic routing by focus
  - focused standalone binding preference
  - disposal cleanup across active and dataset indexes

## PR URL
- Pending (to be filled from opened PR URL).

## Verification
- `npm run lint` ✅
- `npm test -- tests/extension/smoke.test.ts` ✅

## Status request (Done / Blocked / In Progress)
- In Progress (pending PR open and `ready_for_review` transition).

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR to `main`, then set `T-026` to `ready_for_review` with PR number and run task-state linter.
