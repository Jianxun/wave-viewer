# T-070 Scratchpad

## Task summary (DoD + verify)
- Add protocol message parsing/validation for plot X-axis update intent and route it through host transactions.
- Extend workspace reducer/state to persist `plot.xScale` with default linear behavior and guard invalid log toggles (no positive X samples).
- Ensure implementation conforms to frozen ADR/spec decisions from T-068/T-069 without editing ADR/spec/contract files.

Verify:
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts`
- `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `doc/specs/host-webview-protocol.md`
- `agents/adr/ADR-0022-plot-x-axis-linear-log-scale.md`
- `src/core/dataset/types.ts`
- `src/extension/commands.ts`
- `src/extension/types.ts`
- `src/webview/state/workspaceState.ts`
- `src/webview/state/reducer.ts`
- `tests/unit/protocol/messages.test.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Move `T-070` to `in_progress` and keep task-state lint clean.
2. Add failing coverage for protocol validation/routing and workspace reducer x-scale guard semantics.
3. Implement host + reducer/state updates with default linear semantics and strict invalid-log rejection.
4. Run verification, summarize patch, open PR, and mark `ready_for_review`.

## Milestone notes
- Intake complete: task moved to `in_progress`, linter clean, branch `feature/T-070-xscale-protocol-reducer` created.
- Added TDD coverage for new `webview/intent/updatePlotXAxis` protocol payload and host transaction behavior.
- Implemented host intent routing + reducer/state updates for `plot.xScale` and no-positive-X log-toggle rejection.
- Aligned stale smoke fixtures/expectations to schema v3 so required verification targets run green.

## Patch summary
- `src/core/dataset/types.ts`
  - Added `webview/intent/updatePlotXAxis` protocol type support and payload validation (`patch.scale`, `patch.range`).
  - Extended workspace-like payload shape validation to include optional `xScale`.
- `src/extension/types.ts`
  - Added typed `WebviewToHostMessage` variant for `webview/intent/updatePlotXAxis`.
- `src/webview/state/workspaceState.ts`
  - Added optional `plot.xScale` state field.
  - Added `updatePlotXAxis` state operation to persist `xScale`/`xRange`, reject invalid log toggles without positive finite X, and clear non-positive persisted ranges when toggling to log.
- `src/webview/state/reducer.ts`
  - Added `plot/updateXAxis` action and reducer routing.
- `src/extension/commands.ts`
  - Added host intent handler for `webview/intent/updatePlotXAxis`.
  - Routed intent through host transaction with reducer mutation and `updatePlotXAxis:plot-controls` reason.
  - Added dataset-backed X-sample resolution and non-fatal actionable `showError` feedback for invalid log toggles.
- `tests/unit/protocol/messages.test.ts`
  - Added acceptance/rejection coverage for `webview/intent/updatePlotXAxis` payloads.
- `tests/extension/smoke.test.ts`
  - Added host transaction smoke coverage for valid `updatePlotXAxis` and invalid log-toggle rejection behavior.
  - Updated legacy v2 layout fixture helpers/expectations to v3 schema for consistency with current import contract.

## PR URL
- Pending PR creation.

## Verification
- `npm test -- tests/unit/protocol/messages.test.ts tests/extension/smoke.test.ts` ✅
- `npm run lint` ✅

## Status request (Done / Blocked / In Progress)
- In Progress

## Blockers / Questions
- None.

## Next steps
- Push branch, open PR to `main`, set `T-070` to `ready_for_review` with PR number.
