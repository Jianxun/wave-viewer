# T-059 Scratchpad

## Task summary (DoD + verify)
- Title: Adapt frozen bundle export to multi-dataset v2 layouts
- DoD:
  - Update frozen export to emit one frozen CSV per referenced dataset id plus one frozen layout YAML.
  - Ensure exported frozen layout rewrites `datasets[].path` to the generated frozen dataset CSV paths deterministically.
  - Preserve current safety rule: frozen export must not overwrite active interactive layout or active interactive dataset files.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts tests/unit/core/spec/exportSpec.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`

## Plan
- Inspect current frozen export flow in extension command + core exporter + tests.
- Add/adjust export logic for multi-dataset frozen artifacts and deterministic dataset path rewriting.
- Extend regression tests for artifact cardinality, path rewriting, and overwrite safety.
- Run required verification commands and capture results.

## Milestone notes
- Intake complete; task state set to `in_progress`.
- Added TDD coverage first for deterministic dataset export ordering and multi-dataset frozen artifact emission.
- Implemented multi-dataset frozen export pathing, dataset-aware signal selection/validation, and source/x dataset path rewriting.
- Verified targeted tests and lint pass.

## Patch summary
- `src/core/spec/exportSpec.ts`
  - Added `collectExportPlotDatasets(...)` to expose deterministic dataset-id/path ordering used by v2 export.
  - Refactored `exportPlotSpecV1(...)` to use the shared dataset registry output.
- `src/extension/commands.ts`
  - Updated frozen export to emit one CSV per referenced dataset id (`<name>.<dataset-id>.frozen.csv`).
  - Added dataset-aware signal collection/validation and per-dataset CSV generation.
  - Rewrote frozen layout export inputs so `datasets[].path`, plot `x.dataset` references, and trace `sourceId` dataset paths resolve to generated frozen CSVs.
  - Extended overwrite safety to reject any generated frozen CSV path that matches an active interactive dataset path.
- `tests/extension/smoke.test.ts`
  - Updated frozen export assertions for dataset-id CSV naming and message output.
  - Added regression test for multi-dataset frozen bundle export and deterministic rewritten layout paths.
  - Added regression test for overwrite protection against active interactive dataset files.
- `tests/unit/core/spec/exportSpec.test.ts`
  - Added regression test for deterministic dataset-id ordering via `collectExportPlotDatasets(...)`.

## PR URL
- Pending (set during PR open step).

## Verification
- `npm test -- tests/extension/smoke.test.ts tests/unit/core/spec/exportSpec.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- Ready for Review

## Blockers / Questions
- None currently.

## Next steps
- Open PR and set `T-059` to `ready_for_review` with PR number.
