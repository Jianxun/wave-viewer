# T-045 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Add host-level session model that binds each viewer to a selected layout file (`*.wave-viewer.yaml`) and resolves dataset context from that layout.
  - Keep webview tuple-only and intent-only; no YAML IO or file identity logic in webview code.
  - Preserve compatibility path where no explicit layout is chosen by using `<csv>.wave-viewer.yaml` as fallback identity.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/viewerSessions.ts`
- `src/extension/types.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add failing smoke tests for layout-session identity and dataset-context resolution.
2. Implement host viewer-session context with fallback layout identity and explicit layout binding.
3. Update open-viewer command resolution to use session context while keeping webview protocol unchanged.
4. Run required verification and prepare closeout.

## Milestone notes
- Added test coverage for:
  - `<csv>.wave-viewer.yaml` fallback identity in session registry.
  - Explicit layout binding (`bindViewerToLayout`) preserving dataset routing.
  - Open-viewer drop intent resolving dataset context from session resolver.
- Implemented session context in host registry and command deps without adding layout identity logic to webview.

## Patch summary
- Added `ViewerSessionContext` contract (`datasetPath`, `layoutUri`) and viewer-registry APIs for explicit/fallback layout binding.
- Updated viewer session registry to:
  - derive fallback layout identity from dataset path,
  - track session `layoutUri`,
  - expose `getViewerSessionContext`,
  - support `bindViewerToLayout`.
- Updated open-viewer command to resolve dataset context from host session context and use bound dataset identity for replay hydration/state snapshot.
- Updated extension wiring to provide `resolveViewerSessionContext` from host session registry.
- Extended smoke tests for the new host behavior.

## PR URL
- Pending PR creation (will be included in final task report).

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request (Done / Blocked / In Progress)
- In Progress (awaiting PR open + task state closeout).

## Blockers / Questions
- None.

## Next steps
- Push branch and open PR.
- Set `T-045` to `ready_for_review` with PR number and lint task-state file.
