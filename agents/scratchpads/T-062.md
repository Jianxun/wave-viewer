# T-062 Scratchpad

## Task summary (DoD + verify)
- Title: Add regression coverage for reload-driven waveform refresh without new intents.
- DoD:
  - Add tests proving waveform tuples refresh on `Reload All Files` for existing plotted traces without requiring any follow-up add/drop action.
  - Add coverage for layouts with persisted traces (including normalized source-id hydration path) to ensure replay snapshot replacement prevents stale vectors.
  - Ensure no regression for incremental interaction flows that still use tuple upserts.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm test -- tests/unit/webview/plotly/adapter.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/roles/executor.md`
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `tests/extension/smoke.test.ts`
- `tests/unit/protocol/messages.test.ts`
- `tests/unit/webview/plotly/adapter.test.ts`
- `src/extension.ts`
- `src/extension/sidePanel.ts`
- `src/webview/plotly/adapter.ts`

## Plan
1. Add smoke regression tests for reload replay hydration without follow-up intents.
2. Add protocol regressions for replay snapshot payload acceptance and tuple-upsert compatibility.
3. Add adapter regressions for replay replacement stale-vector prevention and incremental upsert continuity.
4. Run verify commands and close out task state.

## Milestone notes
- Intake complete; task selected and set `in_progress`.
- Added smoke regressions that simulate reload replay hydration and persisted trace source-id normalization.
- Added protocol regressions for replay snapshot empty tuple acceptance and tuple-upsert compatibility.
- Added adapter regressions for replay replacement behavior and incremental tuple-upsert behavior.
- Completed verification matrix for task DoD.

## Patch summary
- `tests/extension/smoke.test.ts`
  - Added `T-062` regression tests proving reload replay refreshes existing trace vectors without follow-up intents.
  - Added persisted-trace hydration regression (missing `sourceId`) with normalized CSV/frozen alias resolution.
- `tests/unit/protocol/messages.test.ts`
  - Added coverage for valid `host/replaySnapshot` payload with empty tuple arrays.
  - Added compatibility regression ensuring `host/tupleUpsert` remains valid alongside replay snapshot contract.
- `tests/unit/webview/plotly/adapter.test.ts`
  - Added regression proving replay-style tuple cache replacement updates rendered vectors and prevents stale tuple influence.
  - Added regression proving incremental tuple-upsert updates still render correctly for updated source ids.

## PR URL
- Pending.

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm test -- tests/unit/protocol/messages.test.ts` (pass)
- `npm test -- tests/unit/webview/plotly/adapter.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- In Progress (ready for PR open and `ready_for_review` state update).

## Blockers / Questions
- None.

## Next steps
- Push branch and open PR to `main`.
- Set `T-062` state to `ready_for_review` with PR number and rerun tasks-state linter.
