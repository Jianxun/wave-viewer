# T-057 Scratchpad

## Task summary (DoD + verify)
- Title: Unify viewer-dependent command flows with auto-open and default-layout creation
- DoD:
  - Make `Open Layout (YAML)` succeed when no viewer is active by creating a viewer and applying imported state.
  - Make side-panel `Add to Plot` and `Add to New Axis` auto-open/bind a viewer when none is available instead of warning and dropping delivery.
  - On dataset load, resolve `<csv>.wave-viewer.yaml`: import if present, otherwise create it from initial state; then open viewer bound to that layout.
  - Ensure datasets referenced by opened layouts are auto-registered into explorer loaded-dataset state.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/sidePanel.ts`
- `src/extension/types.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add failing smoke tests for open-layout auto-open and csv-load sidecar import/create flows.
2. Add command/type support for:
   - Open-layout viewer auto-open + referenced dataset registration.
   - CSV-load sidecar resolve/create + viewer bind flow.
3. Wire activation-time helpers to ensure viewer auto-open by dataset and use them for:
   - Side-panel add commands.
   - Open-layout command.
   - Load-csv command.
4. Run verify commands and close out task state.

## Milestone notes
- Intake: T-057 is `ready`; no blocking contract conflicts found.
- Implementation: Added viewer auto-open orchestration in extension activation and command deps.
- Verification: smoke and lint pass after test-first updates.

## Patch summary
- `src/extension.ts`
  - Added forced-dataset open-viewer hinting and `ensureViewerTargetForDataset(...)`.
  - Updated side-panel add-to-plot/new-axis handlers to auto-open a target viewer when missing.
  - Wired `createOpenLayoutCommand` with viewer auto-open + dataset registration callbacks.
  - Wired `createLoadCsvFilesCommand` with sidecar resolve/create, workspace caching, viewer open/bind, and lane/x mapping callbacks.
- `src/extension/commands.ts`
  - Enhanced `createOpenLayoutCommand`:
    - no longer hard-fails before parsing when no active viewer,
    - auto-opens viewer via dependency when needed,
    - auto-registers all datasets referenced by the opened layout.
  - Enhanced `createLoadCsvFilesCommand`:
    - resolves `<csv>.wave-viewer.yaml` sidecar on load,
    - imports sidecar workspace when present,
    - creates sidecar from initial state when missing,
    - opens/binds viewer to the sidecar layout.
  - Added `collectReferencedDatasetPaths(...)` helper.
- `src/extension/types.ts`
  - Extended `OpenLayoutCommandDeps` and `LoadCsvFilesCommandDeps` with optional hooks used by new auto-open and sidecar workflows.
- `tests/extension/smoke.test.ts`
  - Added tests for:
    - open-layout auto-open when no viewer is focused,
    - layout-referenced dataset auto-registration,
    - csv-load sidecar import + viewer bind,
    - csv-load sidecar creation + viewer bind.

## PR URL
- Pending

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- In Progress

## Blockers / Questions
- None.

## Next steps
- Commit implementation and tests.
- Push branch and open PR.
- Update task state to `ready_for_review` with PR number.
