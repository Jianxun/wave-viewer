# T-048 Scratchpad

## Task summary (DoD + verify)
- DoD:
  - Add file watcher plumbing so manual edits to the bound layout file trigger host-side import/validation and `host/statePatch` broadcast.
  - Prevent update loops and race regressions using revision/hash guards and self-write suppression.
  - Define and enforce failure behavior for invalid external edits (error surfaced, previous valid state retained).
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/roles/executor.md`
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/types.ts`
- `src/core/spec/importSpec.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Add failing smoke coverage for external layout edit reload, self-write suppression, and invalid-edit retention behavior.
2. Implement host watcher/reload controller and wire it into extension activation/session binding.
3. Re-run smoke and lint verifies, then close out task state and PR metadata.

## Milestone notes
- Intake complete; task moved to `in_progress`.
- Added smoke tests for:
  - external layout file edits importing into host state and broadcasting `host/statePatch`,
  - self-write suppression using autosave metadata + hash/stat matching,
  - invalid external layout edits preserving prior state and surfacing an error.
- Implemented `createLayoutExternalEditController` and wired it into extension activation with watcher setup for fallback and explicit layout bindings.
- Added manual-save metadata recording so watcher logic can suppress save-triggered self-reloads.
- Reviewer follow-up: fixed watcher lifecycle leak by adding unwatch/ref-count behavior and wiring viewer rebind/close transitions to release layout watchers.

## Patch summary
- Added `createLayoutExternalEditController` in `src/extension.ts` with:
  - debounced file-change handling,
  - content-hash dedupe guard,
  - self-write suppression against autosave metadata,
  - import/validation + host state apply + `host/statePatch` broadcast.
- Wired watcher registration to viewer binding paths (open viewer fallback layout, bind-to-dataset, open layout, save layout as).
- Added `recordSelfWriteMetadata` support in autosave controller and used it for manual save/save-as writes.
- Extended viewer session registry with `getViewerBindingsForLayout` for targeted patch fan-out.
- Added `T-048` smoke tests in `tests/extension/smoke.test.ts`.
- Added `unwatchLayout` API with ref-counted watcher ownership in `createLayoutExternalEditController` so a layout watcher is disposed once no viewers remain bound.
- Added activation-level viewer-to-layout tracking and cleanup on:
  - dataset/layout rebind transitions (unwatch old layout, watch new layout),
  - panel disposal (unwatch last bound layout).
- Added smoke tests proving:
  - duplicate `watchLayout` calls share one underlying watcher until final `unwatchLayout`,
  - pending debounced reloads are canceled once layout is fully unwatched.

## PR URL
- https://github.com/Jianxun/wave-viewer/pull/56

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request (Done / Blocked / In Progress)
- In Progress (follow-up patch ready to push and return to review).

## Blockers / Questions
- None.

## Next steps
- Push follow-up commit and post `[Executor]:` PR comment with reviewer-resolution summary.
