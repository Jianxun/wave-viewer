# T-051 Scratchpad

## Task summary (DoD + verify)
- Update open/save/save-as/autosave/external-reload flows to consume/produce v2 schema only.
- Preserve host-internal canonical axis IDs (`y1..yN`) while mapping to/from user lane IDs in YAML.
- Keep runtime behavior stable: external layout edits must continue to hydrate tuples before state patch.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/types.ts`
- `src/core/spec/importSpec.ts`
- `src/core/spec/exportSpec.ts`
- `src/core/spec/plotSpecV1.ts`
- `tests/extension/smoke.test.ts`

## Plan
- Inspect extension layout open/save/reload flows and current schema translation points.
- Add/adjust smoke tests first for v2-only host workflow behavior.
- Implement host-side lane ID translation defaults and mapping persistence across open/save/save-as/autosave/external reload.
- Run smoke + lint verification.
- Push branch and open PR.

## Milestone notes
- Intake complete; `T-051` moved to `in_progress` and task-state linter passed.
- Identified failing smoke coverage due stale v1 fixtures and missing lane-ID persistence through host save paths.
- Implemented lane-ID map plumbing from v2 import into host workflows and back into v2 export.

## Patch summary
- Added v2 lane-ID mapping metadata to import results and export inputs:
  - `importPlotSpecV1` now returns `laneIdByAxisIdByPlotId` derived from lane order mapping to canonical `y1..yN`.
  - `exportPlotSpecV1` now accepts optional `laneIdByAxisIdByPlotId`, preserves provided user lane IDs, and defaults missing IDs deterministically to `lane-<index>`.
- Wired host layout lifecycle to preserve mapping:
  - `createOpenLayoutCommand` records imported lane-ID maps for the opened layout.
  - `createSaveLayoutCommand` and `createSaveLayoutAsCommand` resolve layout lane-ID maps and pass them to export.
  - Autosave now carries optional lane-ID maps into deterministic YAML persistence.
  - External layout reload records imported lane-ID maps so subsequent saves/autosaves keep user IDs.
- Extended extension command/controller dependency types for lane-ID map resolution/recording.
- Updated smoke tests to use v2 layout fixtures and tightened assertions for:
  - v2-only error messages,
  - external reload tuple hydration stability,
  - lane-ID default (`lane-1`) on save,
  - lane-ID preservation when map exists,
  - open-layout recording of lane-ID mapping.

## PR URL
- Pending (set during closeout).

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request (Done / Blocked / In Progress)
- Done

## Blockers / Questions
- None.

## Next steps
- Push branch and open PR to `main`.
- Set task state to `ready_for_review` with PR number and `merged: false`.
