# T-061 Scratchpad

## Task summary (DoD + verify)
- Title: Replace reload tuple upsert fanout with viewer-scoped replay snapshots.
- DoD:
  - Refactor `Reload All Files` host flow to compute replay payloads per open viewer session and publish `host/replaySnapshot` (not incremental tuple upserts) for reload-triggered updates.
  - Use deterministic dataset matching for replay hydration so imported/frozen/relative-path trace identities still refresh after CSV reload.
  - Remove reload-only heuristics that rely on side effects from later UI actions (for example adding a new plot/trace).
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `agents/roles/executor.md`
- `src/extension.ts`
- `src/extension/commands.ts`
- `src/extension/sidePanel.ts`
- `src/extension/viewerSessions.ts`
- `src/extension/types.ts`
- `tests/extension/smoke.test.ts`

## Plan
1. Update reload command contract so reload completion emits one aggregated callback instead of per-dataset fanout.
2. Refactor `activate` reload handler to compute viewer-scoped replay payloads and emit `host/replaySnapshot`.
3. Add deterministic dataset-path matching utilities for reload hydration (resolved path and frozen-path tolerant matching).
4. Update smoke tests for new reload command callback contract and replay-snapshot behavior expectations where applicable.
5. Run verify commands, then close out scratchpad/status.

## Milestone notes
- Intake complete; task selected and set `in_progress`.
- Updated reload command contract to aggregate successful reload paths and notify host once.
- Replaced reload tuple fanout in activation flow with viewer-scoped `host/replaySnapshot` posting.
- Added deterministic dataset-key matching for replay hydration and reload-reference detection.
- Updated smoke coverage for reload command callback contract.

## Patch summary
- `src/extension/types.ts`
  - Replaced per-dataset `onDatasetReloaded` callback with aggregated `onReloadCompleted(reloadedDatasetPaths)`.
- `src/extension/commands.ts`
  - `createReloadAllLoadedFilesCommand` now batches successful reload paths and fires one completion callback after loop.
- `src/extension.ts`
  - Refactored reload callback to compute replay hydration per bound viewer and emit `host/replaySnapshot` (no reload-time `host/tupleUpsert` fanout).
  - Removed reload-only statePatch/tuple-upsert heuristic branch (`reloadAllFiles:normalizeTraceSourceIds` path).
  - Added deterministic dataset matching helpers for replay hydration and reload reference checks across resolved/frozen path forms.
- `tests/extension/smoke.test.ts`
  - Updated reload command smoke test to validate the new aggregated completion callback behavior.

## PR URL
- Pending.

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- In Progress (ready for commit/PR)

## Blockers / Questions
- None.

## Next steps
- Commit changes, push branch, open PR, set task state to `ready_for_review` with PR number.
