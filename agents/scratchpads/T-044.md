# T-044 - PNG Export Fix

## Task summary (DoD + verify)
- Restore working PNG export/save from the viewer UI.
- Ensure export behavior remains stable for multi-lane and multi-plot workspaces.
- Add regression coverage for the observed failure mode.
- Verify:
  - `npm test -- tests/extension/smoke.test.ts`
  - `npm run lint`

## Read (paths)
- `agents/context/lessons.md`
- `agents/context/contract.md`
- `agents/context/tasks.yaml`
- `agents/context/tasks_state.yaml`
- `agents/context/project_status.md`
- `src/webview/index.html`
- `src/webview/plotly/renderPlot.ts`
- `tests/extension/smoke.test.ts`

## Plan
- Reproduce/confirm export break cause from viewer shell and Plotly config path.
- Add failing regression test for CSP requirement used by PNG export.
- Patch webview CSP and ensure export modebar config remains explicit PNG.
- Run task verify commands and close out.

## Milestone notes
- Reproduced failure as missing CSP allowance for `data:`/`blob:` image sources in webview template.
- Added smoke regression that initially failed against current template.
- Patched CSP and preserved explicit Plotly PNG export options.

## Patch summary
- Updated `src/webview/index.html` CSP meta policy to include:
  - `img-src __CSP_SOURCE__ data: blob:;`
- Updated `src/webview/plotly/renderPlot.ts`:
  - Keep modebar PNG export explicit with `toImageButtonOptions`.
  - Derive sanitized filename from active plot name for multi-plot export clarity.
- Added regression coverage in `tests/extension/smoke.test.ts`:
  - Assert webview template CSP includes image source allowances required for Plotly PNG export flow.

## PR URL
- Pending

## Verification
- `npm test -- tests/extension/smoke.test.ts` (pass)
- `npm run lint` (pass)

## Status request
- In Progress

## Blockers / Questions
- None

## Next steps
- Push branch and open PR to `main`.
- Set `T-044` task state to `ready_for_review` with PR number.
